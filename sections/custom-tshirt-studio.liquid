{% comment %}
  Custom T-Shirt Design Studio Section
  A dedicated section for the custom t-shirt designer with amazing visuals
  Preserves all current working controls, JavaScript, and functionality
{% endcomment %}

<div class="custom-tshirt-studio" id="custom-tshirt-studio-{{ section.id }}" style="display: none;">
  <style>
    .custom-tshirt-studio {
      min-height: 100vh;
      background: #ffffff;
      position: relative;
      overflow: hidden;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .studio-container {
      max-width: 1400px;
      width: 100%;
      padding: 40px 20px;
      position: relative;
      z-index: 2;
      margin: 0 auto;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    
    .studio-header {
      text-align: center;
      margin-bottom: 60px;
      animation: fadeInUp 1s ease-out;
    }
    
    .studio-title {
      font-size: 4rem;
      font-weight: 900;
      color: #0F172A;
      margin: 0 0 20px 0;
      text-shadow: 0 2px 4px rgba(0,0,0,0.1);
      background: linear-gradient(45deg, #27E1C1, #20b2aa, #27E1C1);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      animation: titleGlow 3s ease-in-out infinite alternate;
    }
    
    .studio-subtitle {
      font-size: 1.5rem;
      color: #334155;
      margin: 0 0 30px 0;
      font-weight: 300;
      letter-spacing: 1px;
    }
    
    .studio-description {
      font-size: 1.1rem;
      color: #64748b;
      max-width: 600px;
      margin: 0 auto;
      line-height: 1.6;
    }
    
    /* ===== DARK MODE SUPPORT ===== */
    @media (prefers-color-scheme: dark) {
      .custom-tshirt-studio {
        background: #0F172A;
      }
      
      .studio-title {
        color: #ffffff;
        text-shadow: 0 2px 8px rgba(39, 225, 193, 0.3);
      }
      
      .studio-subtitle {
        color: #cbd5e1;
      }
      
      .studio-description {
        color: #94a3b8;
      }
      
      .design-workspace {
        background: rgba(30, 41, 59, 0.95);
        border: 1px solid rgba(39, 225, 193, 0.2);
      }
    }
    
    [data-theme="dark"] .custom-tshirt-studio {
      background: #0F172A;
    }
    
    [data-theme="dark"] .studio-title {
      color: #ffffff;
      text-shadow: 0 2px 8px rgba(39, 225, 193, 0.3);
    }
    
    [data-theme="dark"] .studio-subtitle {
      color: #cbd5e1;
    }
    
    [data-theme="dark"] .studio-description {
      color: #94a3b8;
    }
    
    [data-theme="dark"] .design-workspace {
      background: rgba(30, 41, 59, 0.95);
      border: 1px solid rgba(39, 225, 193, 0.2);
    }
    
    .design-workspace {
      background: rgba(255,255,255,0.95);
      border-radius: 24px;
      padding: 40px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.2);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255,255,255,0.2);
      animation: slideInUp 1s ease-out 0.3s both;
      position: relative;
      overflow: hidden;
      width: 100%;
      margin: 0 auto;
    }
    
    .workspace-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
      padding-bottom: 20px;
      border-bottom: 2px solid #f0f0f0;
    }
    
    .workspace-title {
      font-size: 2rem;
      font-weight: 700;
      color: #2d3748;
      margin: 0;
    }
    
    .close-studio-btn {
      background: linear-gradient(135deg, #ff6b6b, #ee5a52);
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 50px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(255,107,107,0.4);
    }
    
    .close-studio-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(255,107,107,0.6);
    }
    
    .floating-shapes {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      overflow: hidden;
      z-index: 1;
    }
    
    .shape {
      position: absolute;
      opacity: 0.1;
      animation: float 6s ease-in-out infinite;
    }
    
    .shape:nth-child(1) {
      top: 20%;
      left: 10%;
      width: 80px;
      height: 80px;
      background: linear-gradient(45deg, #ff6b6b, #4ecdc4);
      border-radius: 50%;
      animation-delay: 0s;
    }
    
    .shape:nth-child(2) {
      top: 60%;
      right: 15%;
      width: 120px;
      height: 120px;
      background: linear-gradient(45deg, #a8edea, #fed6e3);
      border-radius: 30% 70% 70% 30% / 30% 30% 70% 70%;
      animation-delay: 2s;
    }
    
    .shape:nth-child(3) {
      bottom: 20%;
      left: 20%;
      width: 60px;
      height: 60px;
      background: linear-gradient(45deg, #ffecd2, #fcb69f);
      border-radius: 50%;
      animation-delay: 4s;
    }
    
    .shape:nth-child(4) {
      top: 40%;
      right: 30%;
      width: 100px;
      height: 100px;
      background: linear-gradient(45deg, #d299c2, #fef9d7);
      border-radius: 20% 80% 80% 20% / 80% 20% 80% 20%;
      animation-delay: 1s;
    }
    
    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    @keyframes slideInUp {
      from {
        opacity: 0;
        transform: translateY(50px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    @keyframes titleGlow {
      from {
        filter: brightness(1) drop-shadow(0 0 10px rgba(255,255,255,0.5));
      }
      to {
        filter: brightness(1.2) drop-shadow(0 0 20px rgba(255,255,255,0.8));
      }
    }
    
    @keyframes float {
      0%, 100% {
        transform: translateY(0px) rotate(0deg);
      }
      50% {
        transform: translateY(-20px) rotate(180deg);
      }
    }
    
    @keyframes canvasGradientShift {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }
    
    .canvas-gradient-animated {
      animation: canvasGradientShift 15s ease infinite !important;
      background-size: 300% 300% !important;
    }
    
    /* ===== ZOOM SLIDER STYLING ===== */
    /* Webkit (Chrome, Safari, Edge) slider thumb */
    .zoom-range::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 22px;
      height: 22px;
      border-radius: 50%;
      background: #ffffff;
      border: 3px solid #27e1c1;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3), 0 0 0 2px rgba(39, 225, 193, 0.2);
      cursor: pointer;
      transition: all 0.15s ease;
    }
    
    .zoom-range::-webkit-slider-thumb:hover {
      transform: scale(1.15);
      box-shadow: 0 4px 12px rgba(39, 225, 193, 0.5), 0 0 0 3px rgba(39, 225, 193, 0.3);
    }
    
    .zoom-range::-webkit-slider-thumb:active {
      transform: scale(1.05);
    }
    
    /* Firefox slider thumb */
    .zoom-range::-moz-range-thumb {
      width: 22px;
      height: 22px;
      border-radius: 50%;
      background: #ffffff;
      border: 3px solid #27e1c1;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3), 0 0 0 2px rgba(39, 225, 193, 0.2);
      cursor: pointer;
      transition: all 0.15s ease;
    }
    
    .zoom-range::-moz-range-thumb:hover {
      transform: scale(1.15);
      box-shadow: 0 4px 12px rgba(39, 225, 193, 0.5), 0 0 0 3px rgba(39, 225, 193, 0.3);
    }
    
    .zoom-range::-moz-range-thumb:active {
      transform: scale(1.05);
    }
    
    /* Focus state for accessibility */
    .zoom-range:focus {
      outline: none;
    }
    
    .zoom-range:focus::-webkit-slider-thumb {
      box-shadow: 0 0 0 4px rgba(39, 225, 193, 0.4);
    }
    
    .zoom-range:focus::-moz-range-thumb {
      box-shadow: 0 0 0 4px rgba(39, 225, 193, 0.4);
    }
    
    .pulse-ring {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 300px;
      height: 300px;
      border: 2px solid rgba(255,255,255,0.3);
      border-radius: 50%;
      animation: pulse 2s ease-in-out infinite;
    }
    
    @keyframes pulse {
      0% {
        transform: translate(-50%, -50%) scale(1);
        opacity: 1;
      }
      100% {
        transform: translate(-50%, -50%) scale(1.5);
        opacity: 0;
      }
    }
    
    @media (max-width: 768px) {
      .custom-tshirt-studio {
        overflow-x: hidden;
        max-width: 100vw;
      }
      
      .studio-title {
        font-size: 2.2rem;
        word-wrap: break-word;
        overflow-wrap: break-word;
        line-height: 1.2;
        padding: 0 15px;
      }
      
      .studio-subtitle {
        font-size: 1.1rem;
        padding: 0 15px;
      }
      
      .studio-description {
        font-size: 1rem;
        padding: 0 15px;
      }
      
      .design-workspace {
        padding: 25px 20px;
        margin: 0 10px;
        border-radius: 20px;
        overflow-x: hidden;
        max-width: calc(100% - 20px);
        box-sizing: border-box;
      }
      
      .workspace-header {
        flex-wrap: wrap;
        gap: 15px;
      }
      
      .workspace-title {
        font-size: 1.3rem;
        word-wrap: break-word;
        overflow-wrap: break-word;
        flex: 1 1 100%;
        text-align: center;
      }
      
      .close-studio-btn {
        flex: 0 0 auto;
        margin: 0 auto;
      }
    }

    /* ===== PRESERVE ALL OUR CURRENT BUTTON ANIMATIONS ===== */
    @keyframes upload-royal-flow {
      0% {
        background-position: 0% 50%;
        box-shadow: 0 8px 32px rgba(30, 64, 175, 0.4);
        transform: scale(1);
      }
      25% {
        background-position: 50% 0%;
        box-shadow: 0 10px 36px rgba(59, 130, 246, 0.5);
        transform: scale(1.01);
      }
      50% {
        background-position: 100% 50%;
        box-shadow: 0 12px 40px rgba(29, 78, 216, 0.6);
        transform: scale(1.02);
      }
      75% {
        background-position: 50% 100%;
        box-shadow: 0 10px 36px rgba(59, 130, 246, 0.5);
        transform: scale(1.01);
      }
      100% {
        background-position: 0% 50%;
        box-shadow: 0 8px 32px rgba(30, 64, 175, 0.4);
        transform: scale(1);
      }
    }

    @keyframes upload-royal-glow {
      0%, 100% {
        box-shadow: 0 8px 32px rgba(30, 64, 175, 0.4), 0 0 20px rgba(59, 130, 246, 0.2);
      }
      50% {
        box-shadow: 0 12px 40px rgba(30, 64, 175, 0.6), 0 0 30px rgba(59, 130, 246, 0.4);
      }
    }

    @keyframes sparkle-float {
      0%, 100% {
        transform: translateY(0px) scale(1);
        opacity: 0.8;
      }
      50% {
        transform: translateY(-8px) scale(1.2);
        opacity: 1;
      }
    }

    @keyframes submit-pulse {
      0%, 100% {
        box-shadow: 0 6px 24px rgba(255, 79, 163, 0.4);
        transform: scale(1);
      }
      50% {
        box-shadow: 0 10px 32px rgba(255, 79, 163, 0.6);
        transform: scale(1.02);
      }
    }

    /* Message animations */
    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateX(100%);
      }
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }
    
    @keyframes slideOut {
      from {
        opacity: 1;
        transform: translateX(0);
      }
      to {
        opacity: 0;
        transform: translateX(100%);
      }
    }

    /* Theme-Responsive Size Chart Button */
    @media (prefers-color-scheme: light) {
      #size-chart-toggle-{{ section.id }} {
        background: linear-gradient(135deg, #3b82f6, #1d4ed8) !important;
        box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3) !important;
      }
      
      #size-chart-toggle-{{ section.id }}:hover {
        background: linear-gradient(135deg, #2563eb, #1e40af) !important;
      }
    }

    @media (prefers-color-scheme: dark) {
      #size-chart-toggle-{{ section.id }} {
        background: linear-gradient(135deg, #1e40af, #1e3a8a) !important;
        box-shadow: 0 4px 12px rgba(30, 64, 175, 0.4) !important;
      }
      
      #size-chart-toggle-{{ section.id }}:hover {
        background: linear-gradient(135deg, #1d4ed8, #1e40af) !important;
      }
    }

    /* Manual theme support */
    .light #size-chart-toggle-{{ section.id }},
    [data-theme="light"] #size-chart-toggle-{{ section.id }} {
      background: linear-gradient(135deg, #3b82f6, #1d4ed8) !important;
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3) !important;
    }

    .dark #size-chart-toggle-{{ section.id }},
    [data-theme="dark"] #size-chart-toggle-{{ section.id }} {
      background: linear-gradient(135deg, #1e40af, #1e3a8a) !important;
      box-shadow: 0 4px 12px rgba(30, 64, 175, 0.4) !important;
    }

    /* Dark Mode Support for Size Chart */
    @media (prefers-color-scheme: dark) {
      .size-chart-container {
        background: #1e293b !important;
        border-color: #334155 !important;
      }
      
      .size-chart-container h5 {
        color: #f1f5f9 !important;
      }
      
      .size-chart-table {
        background: #1e293b !important;
        color: #ffffff !important;
      }
      
      .size-chart-table th {
        background: linear-gradient(135deg, #1e40af, #1d4ed8) !important;
        color: white !important;
      }
      
      .size-chart-table td {
        color: #ffffff !important;
        border-color: #475569 !important;
        background: #334155 !important;
      }
      
      .size-chart-table tr:nth-child(even) td {
        background: #475569 !important;
        color: #ffffff !important;
      }
      
      .size-chart-table tr:nth-child(odd) td {
        background: #334155 !important;
        color: #ffffff !important;
      }
      
      .size-chart-table tr td:first-child {
        background: #f8fafc !important;
        color: #1e293b !important;
        font-weight: 600 !important;
      }
      
      .size-chart-container p {
        background: #fbbf24 !important;
        color: #92400e !important;
      }
    }

    /* Additional dark mode support for any dark theme */
    .dark .size-chart-container,
    [data-theme="dark"] .size-chart-container {
      background: #1e293b !important;
      border-color: #334155 !important;
    }

    .dark .size-chart-container h5,
    [data-theme="dark"] .size-chart-container h5 {
      color: #f1f5f9 !important;
    }

    .dark .size-chart-table,
    [data-theme="dark"] .size-chart-table {
      background: #1e293b !important;
      color: #ffffff !important;
    }

    .dark .size-chart-table th,
    [data-theme="dark"] .size-chart-table th {
      background: linear-gradient(135deg, #1e40af, #1d4ed8) !important;
      color: white !important;
    }

    .dark .size-chart-table td,
    [data-theme="dark"] .size-chart-table td {
      color: #ffffff !important;
      border-color: #475569 !important;
      background: #334155 !important;
    }

    .dark .size-chart-table tr:nth-child(even) td,
    [data-theme="dark"] .size-chart-table tr:nth-child(even) td {
      background: #475569 !important;
      color: #ffffff !important;
    }

    .dark .size-chart-table tr:nth-child(odd) td,
    [data-theme="dark"] .size-chart-table tr:nth-child(odd) td {
      background: #334155 !important;
      color: #ffffff !important;
    }

    .dark .size-chart-table tr td:first-child,
    [data-theme="dark"] .size-chart-table tr td:first-child {
      background: #f8fafc !important;
      color: #1e293b !important;
      font-weight: 600 !important;
    }
  </style>
  
  <!-- Floating Background Shapes -->
  <div class="floating-shapes">
    <div class="shape"></div>
    <div class="shape"></div>
    <div class="shape"></div>
    <div class="shape"></div>
  </div>
  
  <!-- Pulse Ring Effect -->
  <div class="pulse-ring"></div>
  
  <div class="studio-container">
    <div class="studio-header">
      <h1 class="studio-title">üé® Custom T-Shirt Studio</h1>
      <p class="studio-subtitle">Design Your Perfect T-Shirt</p>
      <p class="studio-description">
        Create stunning custom t-shirts with our advanced design tools. Upload your artwork, 
        customize colors, adjust positioning, and see your design come to life in real-time.
      </p>
    </div>
    
    <div class="design-workspace">
      <div class="workspace-header">
        <h2 class="workspace-title">Design Workspace</h2>
        <button class="close-studio-btn" onclick="closeCustomStudio()">
          ‚úï Close Studio
        </button>
      </div>
      
      <!-- OUR CURRENT WORKING INTERACTIVE MOCKUP CONTENT -->
      <div class="custom-designer-container">
        <div id="nt-mockup-{{ section.id }}" class="nt-mockup theme-responsive-section" style="padding: 40px 0 20px 0; background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);">
          <div class="container">
            
            <!-- Section Header -->
            <div class="mockup-header" style="text-align: center; margin-bottom: 30px; padding-top: 10px;">
              <h1 style="font-family: 'Bebas Neue', 'Impact', Arial Black, sans-serif; font-size: 48px; margin: 0 0 20px 0; color: #1f2937; text-shadow: 1px 1px 2px rgba(255,255,255,0.8); letter-spacing: 2px; font-weight: 700; text-transform: uppercase;">
                Custom T-Shirt Design
              </h1>
              <p style="font-size: 20px; color: #374151; margin: 0 0 25px 0; max-width: 700px; margin: 0 auto 25px auto; line-height: 1.6; text-shadow: 1px 1px 2px rgba(255,255,255,0.8);">
                Upload your design and create your own custom t-shirt! 
                <br>Drag, resize, and position your artwork perfectly on the print area.
              </p>
            </div>

            <!-- Design Customization Controls Section -->
            <div style="margin: 40px 0; max-width: 1200px; margin-left: auto; margin-right: auto;">
              <p class="canvas-hint-text" style="color: #374151; font-size: 14px; margin-top: 16px; text-align: center;">
                üí° Tip: Drag the design to move it, use scroll wheel to resize, or use the precise controls below
              </p>

              <!-- Design Customization Controls -->
              <div style="text-align: center; margin: 20px 0 16px 0;">
                <h2 class="canvas-controls-title" style="font-size: 24px; font-weight: 600; color: #1f2937; margin: 0 0 8px 0; text-shadow: 2px 2px 4px rgba(0,0,0,0.1);">üéõÔ∏è Design Customization Controls</h2>
                <p class="canvas-controls-subtitle" style="font-size: 14px; color: #4b5563; margin: 0; text-shadow: 1px 1px 2px rgba(0,0,0,0.05);">Customize your t-shirt design with precision controls</p>
              </div>

              <div class="nt-mockup__controls" style="display: flex; flex-wrap: wrap; gap: 16px; align-items: center; justify-content: center; background: #ffffff; padding: 24px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); border: 1px solid #e5e7eb; margin: 10px 0;">
                    
                    <!-- View Controls -->
                    <div class="nt-mockup__group">
                      <span class="nt-mockup__label" style="font-weight: 600; font-size: 14px; color: #374151; margin-right: 12px;">View</span>
                      <div class="nt-mockup__buttons" role="tablist" aria-label="Mockup view" style="display: flex; gap: 8px;">
                        <button class="nt-btn nt-btn--view is-active enhanced-view-btn" data-view="front" aria-selected="true" style="
                          padding: 12px 20px; 
                          border: 2px solid transparent; 
                          background: linear-gradient(135deg, #27e1c1, #20b2aa); 
                          color: white; 
                          border-radius: 16px; 
                          font-size: 14px; 
                          font-weight: 600; 
                          cursor: pointer; 
                          transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); 
                          box-shadow: 0 4px 16px rgba(39, 225, 193, 0.3);
                          backdrop-filter: blur(10px);
                          -webkit-backdrop-filter: blur(10px);
                        ">
                          üëï Front
                        </button>
                        <button class="nt-btn nt-btn--view enhanced-view-btn" data-view="back" aria-selected="false" style="
                          padding: 12px 20px; 
                          border: 2px solid transparent; 
                          background: linear-gradient(135deg, rgba(255,255,255,0.1), rgba(255,255,255,0.05)); 
                          color: #374151; 
                          border-radius: 16px; 
                          font-size: 14px; 
                          font-weight: 600; 
                          cursor: pointer; 
                          transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); 
                          box-shadow: 0 4px 16px rgba(0,0,0,0.1);
                          backdrop-filter: blur(10px);
                          -webkit-backdrop-filter: blur(10px);
                        ">
                          üëï Back
                        </button>
                        <button class="nt-btn nt-btn--view enhanced-view-btn" data-view="hanging" aria-selected="false" style="
                          padding: 12px 20px; 
                          border: 2px solid transparent; 
                          background: linear-gradient(135deg, rgba(255,255,255,0.1), rgba(255,255,255,0.05)); 
                          color: #374151; 
                          border-radius: 16px; 
                          font-size: 14px; 
                          font-weight: 600; 
                          cursor: pointer; 
                          transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); 
                          box-shadow: 0 4px 16px rgba(0,0,0,0.1);
                          backdrop-filter: blur(10px);
                          -webkit-backdrop-filter: blur(10px);
                        ">
                          üè∑Ô∏è Hanging
                        </button>
                        <button class="nt-btn nt-btn--view enhanced-view-btn" data-view="person1" aria-selected="false" style="
                          padding: 12px 20px; 
                          border: 2px solid transparent; 
                          background: linear-gradient(135deg, rgba(255,255,255,0.1), rgba(255,255,255,0.05)); 
                          color: #374151; 
                          border-radius: 16px; 
                          font-size: 14px; 
                          font-weight: 600; 
                          cursor: pointer; 
                          transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); 
                          box-shadow: 0 4px 16px rgba(0,0,0,0.1);
                          backdrop-filter: blur(10px);
                          -webkit-backdrop-filter: blur(10px);
                        ">
                          üë§ Model 1
                        </button>
                        <button class="nt-btn nt-btn--view enhanced-view-btn" data-view="person2" aria-selected="false" style="
                          padding: 12px 20px; 
                          border: 2px solid transparent; 
                          background: linear-gradient(135deg, rgba(255,255,255,0.1), rgba(255,255,255,0.05)); 
                          color: #374151; 
                          border-radius: 16px; 
                          font-size: 14px; 
                          font-weight: 600; 
                          cursor: pointer; 
                          transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); 
                          box-shadow: 0 4px 16px rgba(0,0,0,0.1);
                          backdrop-filter: blur(10px);
                          -webkit-backdrop-filter: blur(10px);
                        ">
                          üë§ Model 2
                        </button>
                      </div>
                    </div>

                    <!-- Color Selection -->
                    <div class="nt-mockup__group">
                      <span class="nt-mockup__label" style="font-weight: 600; font-size: 14px; color: #374151; margin-right: 12px;">Color</span>
                      <div class="nt-mockup__buttons" style="display: flex; gap: 8px; flex-wrap: wrap;">
                        <button class="nt-btn nt-btn--color enhanced-color-btn" data-color="white" style="
                          padding: 12px 16px; 
                          border: 2px solid transparent; 
                          background: #27e1c1; 
                          color: #0f172a; 
                          border-radius: 16px; 
                          font-size: 14px; 
                          font-weight: 600; 
                          cursor: pointer; 
                          transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); 
                          box-shadow: 0 4px 16px rgba(39, 225, 193, 0.4);
                          backdrop-filter: blur(10px);
                          -webkit-backdrop-filter: blur(10px);
                        ">
                          ‚ö™ White
                        </button>
                        <button class="nt-btn nt-btn--color enhanced-color-btn" data-color="black" style="
                          padding: 12px 16px; 
                          border: 2px solid transparent; 
                          background: #27e1c1; 
                          color: #0f172a; 
                          border-radius: 16px; 
                          font-size: 14px; 
                          font-weight: 600; 
                          cursor: pointer; 
                          transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); 
                          box-shadow: 0 4px 16px rgba(39, 225, 193, 0.4);
                          backdrop-filter: blur(10px);
                          -webkit-backdrop-filter: blur(10px);
                        ">
                          ‚ö´ Black
                        </button>
                      </div>
                    </div>

                    <!-- Enhanced 3D Controls -->
                    <div class="nt-mockup__group" style="background: linear-gradient(135deg, rgba(255,255,255,0.1), rgba(255,255,255,0.05)); padding: 16px; border-radius: 16px; border: 2px solid rgba(255,255,255,0.2); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);">
                      <span class="nt-mockup__label" style="font-weight: 600; font-size: 14px; color: #334155; margin-right: 12px;">üéØ 3D Controls</span>
                      <div class="nt-mockup__buttons" style="display: flex; gap: 8px; flex-wrap: wrap;">
                        <button class="nt-btn nt-btn--3d enhanced-3d-btn" id="nt-3d-rotate-{{ section.id }}" style="
                          padding: 12px 20px; 
                          border: 2px solid transparent; 
                          background: #27e1c1; 
                          color: #0f172a; 
                          border-radius: 16px; 
                          font-size: 14px; 
                          font-weight: 600; 
                          cursor: pointer; 
                          transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); 
                          box-shadow: 0 4px 16px rgba(39, 225, 193, 0.4);
                          backdrop-filter: blur(10px);
                          -webkit-backdrop-filter: blur(10px);
                        ">
                          ‚Ü∫ Rotate
                        </button>
                        <button class="nt-btn nt-btn--zoom enhanced-3d-btn" id="nt-zoom-{{ section.id }}" style="
                          padding: 12px 20px; 
                          border: 2px solid transparent; 
                          background: #27e1c1; 
                          color: #0f172a; 
                          border-radius: 16px; 
                          font-size: 14px; 
                          font-weight: 600; 
                          cursor: pointer; 
                          transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); 
                          box-shadow: 0 4px 16px rgba(39, 225, 193, 0.4);
                          backdrop-filter: blur(10px);
                          -webkit-backdrop-filter: blur(10px);
                        ">
                          üîç Zoom
                        </button>
                        <button class="nt-btn nt-btn--validate enhanced-3d-btn" id="nt-validate-{{ section.id }}" style="
                          padding: 12px 20px; 
                          border: 2px solid transparent; 
                          background: #27e1c1; 
                          color: #0f172a; 
                          border-radius: 16px; 
                          font-size: 14px; 
                          font-weight: 600; 
                          cursor: pointer; 
                          transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); 
                          box-shadow: 0 4px 16px rgba(39, 225, 193, 0.4);
                          backdrop-filter: blur(10px);
                          -webkit-backdrop-filter: blur(10px);
                        ">
                          ‚úÖ Validate
                        </button>
                        <button class="nt-btn nt-btn--reset enhanced-3d-btn" id="nt-reset-{{ section.id }}" style="
                          padding: 12px 20px; 
                          border: 2px solid transparent; 
                          background: #27e1c1; 
                          color: #0f172a; 
                          border-radius: 16px; 
                          font-size: 14px; 
                          font-weight: 600; 
                          cursor: pointer; 
                          transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); 
                          box-shadow: 0 4px 16px rgba(39, 225, 193, 0.4);
                          backdrop-filter: blur(10px);
                          -webkit-backdrop-filter: blur(10px);
                        ">
                          üîÑ Reset
                        </button>
                      </div>
                    </div>

                    <!-- Action Buttons - Organized Grid Layout -->
                    <!-- NOTE: Upload, Perfect Fit, and Submit buttons moved below canvas -->
                    <div class="nt-mockup__group">
                      
                      <!-- Action Buttons Grid -->
                      <div class="action-buttons-grid" style="
                        display: grid;
                        grid-template-columns: 1fr 1fr;
                        gap: 12px;
                        margin-bottom: 12px;
                      ">
                        <button class="nt-btn nt-btn--download" id="nt-download-{{ section.id }}" style="
                          padding: 14px 20px; 
                          border: 2px solid transparent; 
                          background: #27e1c1; 
                          color: #0f172a; 
                          border-radius: 16px; 
                          font-size: 14px; 
                          font-weight: 600; 
                          cursor: pointer; 
                          transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); 
                          box-shadow: 0 4px 16px rgba(39, 225, 193, 0.4);
                          backdrop-filter: blur(10px);
                          -webkit-backdrop-filter: blur(10px);
                          display: flex;
                          align-items: center;
                          justify-content: center;
                          gap: 8px;
                        ">
                          üíæ Download Mockup
                        </button>
                        <button class="nt-btn nt-btn--edit" id="nt-edit-{{ section.id }}" style="
                          padding: 14px 20px; 
                          border: 2px solid transparent; 
                          background: #27e1c1; 
                          color: #0f172a; 
                          border-radius: 16px; 
                          font-size: 14px; 
                          font-weight: 600; 
                          cursor: pointer; 
                          transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); 
                          box-shadow: 0 4px 16px rgba(39, 225, 193, 0.4);
                          backdrop-filter: blur(10px);
                          -webkit-backdrop-filter: blur(10px);
                          display: flex;
                          align-items: center;
                          justify-content: center;
                          gap: 8px;
                        ">
                          ‚úèÔ∏è Edit Design
                        </button>
                      </div>
                      
                      <!-- Primary Action Buttons -->
                      <div class="primary-actions" style="
                        display: grid;
                        grid-template-columns: 1fr 1fr;
                        gap: 12px;
                        margin-bottom: 12px;
                      ">
                        <button class="nt-btn nt-btn--placement" id="nt-toggle-guide-{{ section.id }}" style="
                          padding: 14px 20px; 
                          border: 2px solid transparent; 
                          background: #27e1c1; 
                          color: #0f172a; 
                          border-radius: 16px; 
                          font-size: 14px; 
                          font-weight: 600; 
                          cursor: pointer; 
                          transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); 
                          box-shadow: 0 4px 16px rgba(39, 225, 193, 0.4);
                          backdrop-filter: blur(10px);
                          -webkit-backdrop-filter: blur(10px);
                          display: flex;
                          align-items: center;
                          justify-content: center;
                          gap: 8px;
                        ">
                          üìê <span id="nt-guide-text-{{ section.id }}">Show</span> Placement Guide
                        </button>
                        <button class="nt-btn nt-btn--remove" id="nt-remove-{{ section.id }}" style="
                          padding: 14px 20px; 
                          border: 2px solid transparent; 
                          background: linear-gradient(135deg, #ef4444, #dc2626); 
                          color: white; 
                          border-radius: 16px; 
                          font-size: 14px; 
                          font-weight: 600; 
                          cursor: pointer; 
                          transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); 
                          box-shadow: 0 4px 16px rgba(239, 68, 68, 0.3);
                          backdrop-filter: blur(10px);
                          -webkit-backdrop-filter: blur(10px);
                          display: flex;
                          align-items: center;
                          justify-content: center;
                          gap: 8px;
                        ">
                          üóëÔ∏è Remove Design
                        </button>
                      </div>
                      
                      <!-- Perfect Fit and Submit Request buttons moved below canvas -->
                    </div>
                  </div>
                </div>
            <!-- END Design Customization Controls Section -->

            <!-- Size Chart - Collapsible -->
            <div class="size-chart-container" style="margin: 20px auto; max-width: 1200px; display: flex; flex-direction: column; align-items: center; text-align: center;">
              <button id="size-chart-toggle-{{ section.id }}" style="width: 100%; padding: 16px; background: linear-gradient(135deg, #0ea5e9, #0284c7); color: white; border: none; border-radius: 12px; font-size: 16px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; position: relative; box-shadow: 0 4px 12px rgba(14, 165, 233, 0.3); transition: all 0.3s ease;">
                <span>üìè Size Chart</span>
                <span id="size-chart-icon-{{ section.id }}" style="position: absolute; right: 16px; font-size: 18px; transition: transform 0.3s ease;">‚ñº</span>
              </button>
              <div id="size-chart-content-{{ section.id }}" style="display: none; margin-top: 16px; padding: 16px; background: #f0f9ff; border-radius: 12px; border: 1px solid #0ea5e9; width: 100%;">
              <div style="overflow-x: auto; display: flex; justify-content: center;">
                <table class="size-chart-table" style="border-collapse: collapse; font-size: 12px; background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.1); min-width: 600px;">
                  <thead>
                    <tr style="background: linear-gradient(135deg, #0ea5e9, #0284c7); color: white;">
                      <th style="padding: 8px; text-align: left; font-weight: 600;">Size</th>
                      <th style="padding: 8px; text-align: center; font-weight: 600;">XS</th>
                      <th style="padding: 8px; text-align: center; font-weight: 600;">S</th>
                      <th style="padding: 8px; text-align: center; font-weight: 600;">M</th>
                      <th style="padding: 8px; text-align: center; font-weight: 600;">L</th>
                      <th style="padding: 8px; text-align: center; font-weight: 600;">XL</th>
                      <th style="padding: 8px; text-align: center; font-weight: 600;">2XL</th>
                      <th style="padding: 8px; text-align: center; font-weight: 600;">3XL</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr style="border-bottom: 1px solid #e5e7eb;">
                      <td style="padding: 8px; font-weight: 600; background: #f9fafb;">Chest (inches)</td>
                      <td style="padding: 8px; text-align: center;">32-34</td>
                      <td style="padding: 8px; text-align: center;">35-37</td>
                      <td style="padding: 8px; text-align: center;">38-40</td>
                      <td style="padding: 8px; text-align: center;">41-43</td>
                      <td style="padding: 8px; text-align: center;">44-46</td>
                      <td style="padding: 8px; text-align: center;">47-49</td>
                      <td style="padding: 8px; text-align: center;">50-52</td>
                    </tr>
                    <tr style="border-bottom: 1px solid #e5e7eb;">
                      <td style="padding: 8px; font-weight: 600; background: #f9fafb;">Length (inches)</td>
                      <td style="padding: 8px; text-align: center;">26</td>
                      <td style="padding: 8px; text-align: center;">27</td>
                      <td style="padding: 8px; text-align: center;">28</td>
                      <td style="padding: 8px; text-align: center;">29</td>
                      <td style="padding: 8px; text-align: center;">30</td>
                      <td style="padding: 8px; text-align: center;">31</td>
                      <td style="padding: 8px; text-align: center;">32</td>
                    </tr>
                    <tr style="border-bottom: 1px solid #e5e7eb;">
                      <td style="padding: 8px; font-weight: 600; background: #f9fafb;">Sleeve Length</td>
                      <td style="padding: 8px; text-align: center;">8</td>
                      <td style="padding: 8px; text-align: center;">8.5</td>
                      <td style="padding: 8px; text-align: center;">9</td>
                      <td style="padding: 8px; text-align: center;">9.5</td>
                      <td style="padding: 8px; text-align: center;">10</td>
                      <td style="padding: 8px; text-align: center;">10.5</td>
                      <td style="padding: 8px; text-align: center;">11</td>
                    </tr>
                    <tr>
                      <td style="padding: 8px; font-weight: 600; background: #f9fafb;">Fit</td>
                      <td style="padding: 8px; text-align: center;">Slim</td>
                      <td style="padding: 8px; text-align: center;">Slim</td>
                      <td style="padding: 8px; text-align: center;">Regular</td>
                      <td style="padding: 8px; text-align: center;">Regular</td>
                      <td style="padding: 8px; text-align: center;">Regular</td>
                      <td style="padding: 8px; text-align: center;">Relaxed</td>
                      <td style="padding: 8px; text-align: center;">Relaxed</td>
                    </tr>
                  </tbody>
                </table>
              </div>
              <div style="margin-top: 16px; padding: 12px; background: #fef3c7; border-radius: 8px; border-left: 4px solid #f59e0b; text-align: center;">
                <p style="margin: 0; color: #92400e; font-size: 14px; font-weight: 500;">
                  <strong>üí° Size Guide Tip:</strong> Measure your chest at the fullest point, keeping the tape measure parallel to the ground. If you're between sizes, we recommend sizing up for a more comfortable fit.
                </p>
              </div>
              <div style="margin-top: 12px; padding: 12px; background: #ecfdf5; border-radius: 8px; border-left: 4px solid #10b981; text-align: center;">
                <p style="margin: 0; color: #065f46; font-size: 14px;">
                  <strong>üìê How to Measure:</strong>
                </p>
                <ul style="margin: 8px 0 0 0; padding-left: 20px; color: #065f46; font-size: 13px; text-align: left; display: inline-block;">
                  <li><strong>Chest:</strong> Measure around the fullest part of your chest</li>
                  <li><strong>Length:</strong> Measure from shoulder to bottom hem</li>
                  <li><strong>Sleeve:</strong> Measure from shoulder to wrist</li>
                </ul>
              </div>
              </div>
            </div>

            <!-- Enhanced Preview Stage -->
            <div class="nt-mockup__stage" style="width: 100%; display: flex; justify-content: center; align-items: center; margin-top: 30px !important; margin-bottom: 40px !important; padding: 0; box-sizing: border-box;">
                <div class="nt-mockup__canvas canvas-gradient-animated" 
                     id="nt-mockup-canvas-{{ section.id }}"
                     style="
                       position: relative;
                       width: min(900px, 90%);
                       max-width: 90vw;
                       aspect-ratio: 1;
                       margin: 0 auto;
                       background: linear-gradient(135deg, #27e1c1 0%, #667eea 20%, #764ba2 35%, #f093fb 50%, #4facfe 65%, #27e1c1 100%);
                       background-size: 300% 300%;
                       animation: canvasGradientShift 15s ease infinite;
                       border-radius: 20px;
                       overflow: visible;
                       box-shadow: 0 25px 80px rgba(39, 225, 193, 0.3), 0 10px 30px rgba(0,0,0,0.2);
                       padding: 40px;
                       --overlay-top: 45%;
                       --overlay-left: 25%;
                       --overlay-width: 60%;
                       --overlay-height: 65%;
                       --overlay-rotate: 0deg;
                       overflow: hidden;
                       backdrop-filter: blur(10px);
                       -webkit-backdrop-filter: blur(10px);
                     ">
                    
                    <!-- T-shirt Mockup Container -->
                    <div style="position: relative; width: 100%; aspect-ratio: 1 / 1; cursor: grab;">
                  
                      <!-- Base Mockup (swapped by JS) -->
                      <img
                        id="nt-base-{{ section.id }}"
                        class="nt-mockup__base"
                        src="{{ 'tshirt-view.png' | asset_url }}"
                        alt="T-shirt mockup"
                        loading="eager"
                        decoding="async"
                        style="position: absolute; inset: 0; width: 100%; height: 100%; object-fit: contain; pointer-events: none;"
                        onerror="console.error('‚ùå Failed to load t-shirt image:', this.src);"
                        onload="console.log('‚úÖ T-shirt image loaded:', this.src);"
                      >
                    
                    <!-- Debug assets (hidden) -->
                    <div id="debug-assets-{{ section.id }}" style="position: absolute; top: -100px; left: -100px; width: 1px; height: 1px; overflow: hidden;">
                      <img src="{{ 'tshirt-view.png' | asset_url }}" onload="console.log('‚úÖ Direct asset test - tshirt-view.png loaded:', this.src);" onerror="console.error('‚ùå Direct asset test - tshirt-view.png failed:', this.src);">
                      <img src="{{ 'Girl-Model.png' | asset_url }}" onload="console.log('‚úÖ Direct asset test - Girl-Model.png loaded:', this.src);" onerror="console.error('‚ùå Direct asset test - Girl-Model.png failed:', this.src);">
                      <img src="{{ 'Women-side.png' | asset_url }}" onload="console.log('‚úÖ Direct asset test - Women-side.png loaded:', this.src);" onerror="console.error('‚ùå Direct asset test - Women-side.png failed:', this.src);">
                    </div>
                    
                    <!-- Dynamic Design Overlay - Aligned with print area -->
                    <div
                      id="nt-overlay-{{ section.id }}"
                      class="nt-mockup__overlay"
                      style="position: absolute; width: var(--overlay-width); height: var(--overlay-height); left: 50%; top: var(--overlay-top); transform: translateX(-50%) rotate(var(--overlay-rotate)); inset: auto; display: flex; align-items: center; justify-content: center; cursor: grab; transition: all 0.1s ease; border: 2px dashed rgba(39, 225, 193, 0.3); border-radius: 8px; background: rgba(39, 225, 193, 0.05);"
                    >
                      <span id="nt-design-text-{{ section.id }}" 
                            style="font-family: 'Bebas Neue', sans-serif; font-size: 32px; font-weight: bold; color: #000000; text-align: center; white-space: nowrap; user-select: none; text-shadow: 1px 1px 2px rgba(255,255,255,0.8); pointer-events: none;">
                        Your Design Here
                      </span>
                      
                      <!-- Drag Handle (only visible when dragging) -->
                      <div id="nt-drag-handle-{{ section.id }}" 
                           style="position: absolute; top: -8px; right: -8px; width: 16px; height: 16px; background: #27e1c1; border: 2px solid white; border-radius: 50%; cursor: grab; display: none; box-shadow: 0 2px 8px rgba(0,0,0,0.2);">
                      </div>
                      
                      <!-- Enhanced Resize Handles - All Directions (Hidden by default, shown when selected) -->
                      <!-- Top-Left -->
                      <div class="resize-handle" data-direction="nw" 
                           style="position: absolute; top: -15px; left: -15px; width: 30px; height: 30px; background: linear-gradient(135deg, #ff6b6b, #ee5a52); border: 4px solid white; border-radius: 50%; cursor: nw-resize; display: none; box-shadow: 0 6px 20px rgba(255,107,107,0.4), 0 2px 8px rgba(0,0,0,0.2); z-index: 10; touch-action: none; transition: all 0.2s ease;"
                           title="Resize from top-left">
                        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 8px; height: 8px; background: white; border-radius: 50%;"></div>
                      </div>
                      
                      <!-- Top-Right -->
                      <div class="resize-handle" data-direction="ne" 
                           style="position: absolute; top: -15px; right: -15px; width: 30px; height: 30px; background: linear-gradient(135deg, #ff6b6b, #ee5a52); border: 4px solid white; border-radius: 50%; cursor: ne-resize; display: none; box-shadow: 0 6px 20px rgba(255,107,107,0.4), 0 2px 8px rgba(0,0,0,0.2); z-index: 10; touch-action: none; transition: all 0.2s ease;"
                           title="Resize from top-right">
                        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 8px; height: 8px; background: white; border-radius: 50%;"></div>
                      </div>
                      
                      <!-- Bottom-Left -->
                      <div class="resize-handle" data-direction="sw" 
                           style="position: absolute; bottom: -15px; left: -15px; width: 30px; height: 30px; background: linear-gradient(135deg, #ff6b6b, #ee5a52); border: 4px solid white; border-radius: 50%; cursor: sw-resize; display: none; box-shadow: 0 6px 20px rgba(255,107,107,0.4), 0 2px 8px rgba(0,0,0,0.2); z-index: 10; touch-action: none; transition: all 0.2s ease;"
                           title="Resize from bottom-left">
                        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 8px; height: 8px; background: white; border-radius: 50%;"></div>
                      </div>
                      
                      <!-- Bottom-Right -->
                      <div class="resize-handle" data-direction="se" 
                           style="position: absolute; bottom: -15px; right: -15px; width: 30px; height: 30px; background: linear-gradient(135deg, #ff6b6b, #ee5a52); border: 4px solid white; border-radius: 50%; cursor: se-resize; display: none; box-shadow: 0 6px 20px rgba(255,107,107,0.4), 0 2px 8px rgba(0,0,0,0.2); z-index: 10; touch-action: none; transition: all 0.2s ease;"
                           title="Resize from bottom-right">
                        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 8px; height: 8px; background: white; border-radius: 50%;"></div>
                      </div>
                      
                      <!-- Top Edge -->
                      <div class="resize-handle" data-direction="n" 
                           style="position: absolute; top: -15px; left: 50%; transform: translateX(-50%); width: 30px; height: 30px; background: linear-gradient(135deg, #20bf6b, #26a69a); border: 4px solid white; border-radius: 50%; cursor: n-resize; display: none; box-shadow: 0 6px 20px rgba(32,191,107,0.4), 0 2px 8px rgba(0,0,0,0.2); z-index: 10; touch-action: none; transition: all 0.2s ease;"
                           title="Resize from top">
                        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 8px; height: 8px; background: white; border-radius: 50%;"></div>
                      </div>
                      
                      <!-- Bottom Edge -->
                      <div class="resize-handle" data-direction="s" 
                           style="position: absolute; bottom: -15px; left: 50%; transform: translateX(-50%); width: 30px; height: 30px; background: linear-gradient(135deg, #20bf6b, #26a69a); border: 4px solid white; border-radius: 50%; cursor: s-resize; display: none; box-shadow: 0 6px 20px rgba(32,191,107,0.4), 0 2px 8px rgba(0,0,0,0.2); z-index: 10; touch-action: none; transition: all 0.2s ease;"
                           title="Resize from bottom">
                        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 8px; height: 8px; background: white; border-radius: 50%;"></div>
                      </div>
                      
                      <!-- Left Edge -->
                      <div class="resize-handle" data-direction="w" 
                           style="position: absolute; left: -15px; top: 50%; transform: translateY(-50%); width: 30px; height: 30px; background: linear-gradient(135deg, #20bf6b, #26a69a); border: 4px solid white; border-radius: 50%; cursor: w-resize; display: none; box-shadow: 0 6px 20px rgba(32,191,107,0.4), 0 2px 8px rgba(0,0,0,0.2); z-index: 10; touch-action: none; transition: all 0.2s ease;"
                           title="Resize from left">
                        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 8px; height: 8px; background: white; border-radius: 50%;"></div>
                      </div>
                      
                      <!-- Right Edge -->
                      <div class="resize-handle" data-direction="e" 
                           style="position: absolute; right: -15px; top: 50%; transform: translateY(-50%); width: 30px; height: 30px; background: linear-gradient(135deg, #20bf6b, #26a69a); border: 4px solid white; border-radius: 50%; cursor: e-resize; display: none; box-shadow: 0 6px 20px rgba(32,191,107,0.4), 0 2px 8px rgba(0,0,0,0.2); z-index: 10; touch-action: none; transition: all 0.2s ease;"
                           title="Resize from right">
                        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 8px; height: 8px; background: white; border-radius: 50%;"></div>
                      </div>
                    </div>
                    
                    <!-- Close T-shirt Mockup Container -->
                    </div>
                    
                    <!-- Canvas Nudge Controls -->
                    <div id="canvas-nudge-controls-{{ section.id }}" style="
                      position: absolute;
                      bottom: 20px;
                      right: 20px;
                      opacity: 0;
                      pointer-events: none;
                      transition: opacity 0.3s ease;
                      z-index: 100;
                    ">
                      <div style="
                        background: rgba(15, 23, 42, 0.95);
                        border: 2px solid #27e1c1;
                        border-radius: 16px;
                        padding: 12px;
                        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5), 0 0 20px rgba(39, 225, 193, 0.3);
                        backdrop-filter: blur(10px);
                        -webkit-backdrop-filter: blur(10px);
                      ">
                        <div style="
                          color: #27e1c1;
                          font-size: 11px;
                          font-weight: 600;
                          text-align: center;
                          margin-bottom: 8px;
                          text-transform: uppercase;
                          letter-spacing: 0.5px;
                        ">Nudge (Arrow Keys)</div>
                        
                        <!-- Arrow Controls Grid -->
                        <div style="
                          display: grid;
                          grid-template-columns: repeat(3, 40px);
                          grid-template-rows: repeat(3, 40px);
                          gap: 4px;
                        ">
                          <!-- Top Row -->
                          <div></div>
                          <button class="canvas-nudge-btn" data-direction="up" style="
                            background: rgba(255, 255, 255, 0.95);
                            border: 2px solid #27e1c1;
                            border-radius: 8px;
                            cursor: pointer;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            transition: all 0.2s ease;
                            padding: 0;
                          " onmouseover="this.style.background='#27e1c1'; this.style.transform='translateY(-2px)'" 
                             onmouseout="this.style.background='rgba(255, 255, 255, 0.95)'; this.style.transform='translateY(0)'">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
                              <path d="M12 19V5m0 0l-7 7m7-7l7 7"/>
                            </svg>
                          </button>
                          <div></div>
                          
                          <!-- Middle Row -->
                          <button class="canvas-nudge-btn" data-direction="left" style="
                            background: rgba(255, 255, 255, 0.95);
                            border: 2px solid #27e1c1;
                            border-radius: 8px;
                            cursor: pointer;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            transition: all 0.2s ease;
                            padding: 0;
                          " onmouseover="this.style.background='#27e1c1'; this.style.transform='translateX(-2px)'" 
                             onmouseout="this.style.background='rgba(255, 255, 255, 0.95)'; this.style.transform='translateX(0)'">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
                              <path d="M19 12H5m0 0l7-7m-7 7l7 7"/>
                            </svg>
                          </button>
                          <div style="
                            background: rgba(39, 225, 193, 0.1);
                            border: 2px dashed rgba(39, 225, 193, 0.3);
                            border-radius: 8px;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                          ">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#27e1c1" stroke-width="2">
                              <circle cx="12" cy="12" r="1"/>
                            </svg>
                          </div>
                          <button class="canvas-nudge-btn" data-direction="right" style="
                            background: rgba(255, 255, 255, 0.95);
                            border: 2px solid #27e1c1;
                            border-radius: 8px;
                            cursor: pointer;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            transition: all 0.2s ease;
                            padding: 0;
                          " onmouseover="this.style.background='#27e1c1'; this.style.transform='translateX(2px)'" 
                             onmouseout="this.style.background='rgba(255, 255, 255, 0.95)'; this.style.transform='translateX(0)'">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
                              <path d="M5 12h14m0 0l-7-7m7 7l-7 7"/>
                            </svg>
                          </button>
                          
                          <!-- Bottom Row -->
                          <div></div>
                          <button class="canvas-nudge-btn" data-direction="down" style="
                            background: rgba(255, 255, 255, 0.95);
                            border: 2px solid #27e1c1;
                            border-radius: 8px;
                            cursor: pointer;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            transition: all 0.2s ease;
                            padding: 0;
                          " onmouseover="this.style.background='#27e1c1'; this.style.transform='translateY(2px)'" 
                             onmouseout="this.style.background='rgba(255, 255, 255, 0.95)'; this.style.transform='translateY(0)'">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
                              <path d="M12 5v14m0 0l7-7m-7 7l-7-7"/>
                            </svg>
                          </button>
                          <div></div>
                        </div>
                      </div>
                    </div>
                </div>
                
                <!-- Canvas Zoom Slider - Inside Canvas Container -->
                <div class="zoom-bar" role="group" aria-label="Zoom controls" style="
                  position: absolute;
                  left: 50%;
                  bottom: 16px;
                  transform: translateX(-50%);
                  display: flex;
                  align-items: center;
                  gap: 10px;
                  padding: 8px 16px;
                  border-radius: 999px;
                  background: rgba(15, 23, 42, 0.85);
                  backdrop-filter: blur(8px);
                  -webkit-backdrop-filter: blur(8px);
                  box-shadow: 0 8px 24px rgba(0, 0, 0, 0.25), 0 0 0 1px rgba(39, 225, 193, 0.2);
                  z-index: 5;
                  transition: all 0.3s ease;
                ">
                  <!-- Magnifying Glass Icon -->
                  <span class="zoom-icon" aria-hidden="true" style="
                    font-size: 20px;
                    line-height: 1;
                    filter: drop-shadow(0 2px 4px rgba(39, 225, 193, 0.3));
                  ">üîç</span>
                  
                  <!-- Range Slider -->
                  <input
                    id="nt-zoom-range-{{ section.id }}"
                    class="zoom-range"
                    type="range"
                    min="50"
                    max="200"
                    step="5"
                    value="100"
                    aria-label="Zoom percentage"
                    style="
                      -webkit-appearance: none;
                      appearance: none;
                      width: min(60vw, 280px);
                      height: 6px;
                      border-radius: 999px;
                      background: linear-gradient(90deg, #27e1c1, #1aa394);
                      outline: none;
                      cursor: pointer;
                      transition: opacity 0.2s;
                    "
                  />
                  
                  <!-- Zoom Percentage Label -->
                  <output 
                    id="nt-zoom-label-{{ section.id }}" 
                    class="zoom-label" 
                    for="nt-zoom-range-{{ section.id }}"
                    style="
                      min-width: 52px;
                      text-align: right;
                      font-weight: 700;
                      font-size: 14px;
                      color: #e6f9f5;
                      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
                    "
                  >100%</output>
                </div>
            </div>
            
            <!-- 3-Step Workflow Section - Below Canvas -->
            <div class="canvas-action-buttons workflow-steps" style="
              display: flex;
              flex-direction: column;
              align-items: center;
              gap: 28px;
              margin-top: 30px;
              max-width: 650px;
              margin-left: auto;
              margin-right: auto;
              padding: 0 20px;
            ">
              
              <!-- Step 1: Upload Your Design -->
              <div class="workflow-step step-1" style="
                width: 100%;
                display: flex;
                flex-direction: column;
                align-items: center;
                text-align: center;
              ">
                <div class="step-label" style="
                  font-size: 1rem;
                  font-weight: 700;
                  color: #667eea;
                  text-transform: uppercase;
                  letter-spacing: 1.5px;
                  margin-bottom: 12px;
                  display: flex;
                  align-items: center;
                  gap: 8px;
                ">
                  <span style="
                    background: linear-gradient(135deg, #667eea, #764ba2);
                    color: white;
                    width: 32px;
                    height: 32px;
                    border-radius: 50%;
                    display: inline-flex;
                    align-items: center;
                    justify-content: center;
                    font-weight: 800;
                    font-size: 16px;
                    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
                  ">1</span>
                  <span style="background: linear-gradient(135deg, #667eea, #764ba2); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">Step 1</span>
                </div>
                
                <button class="nt-btn nt-btn--upload upload-hero-btn" id="nt-upload-{{ section.id }}" style="
                  width: 100%;
                  padding: 20px 40px; 
                  border: 2px solid transparent; 
                  background: linear-gradient(135deg, #1e40af, #3b82f6, #1d4ed8, #1e40af); 
                  background-size: 300% 300%;
                  color: white; 
                  border-radius: 20px; 
                  font-size: 18px; 
                  font-weight: 700; 
                  cursor: pointer; 
                  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); 
                  box-shadow: 0 8px 32px rgba(30, 64, 175, 0.4);
                  backdrop-filter: blur(10px);
                  -webkit-backdrop-filter: blur(10px);
                  position: relative;
                  overflow: hidden;
                  text-transform: uppercase;
                  letter-spacing: 1px;
                  animation: upload-royal-flow 3s ease-in-out infinite;
                  margin-bottom: 10px;
                ">
                  <span style="position: relative; z-index: 2; display: flex; align-items: center; justify-content: center; gap: 10px;">
                    üìÅ Upload Your Design
                    <span class="upload-sparkle" style="
                      position: absolute;
                      width: 4px;
                      height: 4px;
                      background: rgba(255, 255, 255, 0.8);
                      border-radius: 50%;
                      animation: sparkle-float 2s ease-in-out infinite;
                    "></span>
                    <span class="upload-sparkle" style="
                      position: absolute;
                      width: 3px;
                      height: 3px;
                      background: rgba(255, 255, 255, 0.6);
                      border-radius: 50%;
                      animation: sparkle-float 2s ease-in-out infinite 0.5s;
                    "></span>
                  </span>
                </button>
                
                <p class="step-description" style="
                  font-size: 0.9rem;
                  color: #64748b;
                  line-height: 1.6;
                  margin: 0;
                  max-width: 90%;
                ">
                  Upload your custom artwork or image to preview it on the shirt.
                </p>
              </div>
              
              <!-- Step 2: Perfect Fit -->
              <div class="workflow-step step-2" style="
                width: 100%;
                display: flex;
                flex-direction: column;
                align-items: center;
                text-align: center;
              ">
                <div class="step-label" style="
                  font-size: 1rem;
                  font-weight: 700;
                  color: #06b6d4;
                  text-transform: uppercase;
                  letter-spacing: 1.5px;
                  margin-bottom: 12px;
                  display: flex;
                  align-items: center;
                  gap: 8px;
                ">
                  <span style="
                    background: linear-gradient(135deg, #06b6d4, #0891b2);
                    color: white;
                    width: 32px;
                    height: 32px;
                    border-radius: 50%;
                    display: inline-flex;
                    align-items: center;
                    justify-content: center;
                    font-weight: 800;
                    font-size: 16px;
                    box-shadow: 0 4px 12px rgba(6, 182, 212, 0.4);
                  ">2</span>
                  <span style="background: linear-gradient(135deg, #06b6d4, #0891b2); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">Step 2</span>
                </div>
                
                <button class="nt-btn nt-btn--perfect-fit" id="nt-perfect-fit-btn-{{ section.id }}" style="
                  width: 100%;
                  padding: 18px 36px; 
                  border: 2px solid transparent; 
                  background: linear-gradient(135deg, #06b6d4, #0891b2); 
                  color: white; 
                  border-radius: 18px; 
                  font-size: 16px; 
                  font-weight: 600; 
                  cursor: pointer; 
                  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); 
                  box-shadow: 0 6px 24px rgba(6, 182, 212, 0.3);
                  backdrop-filter: blur(10px);
                  -webkit-backdrop-filter: blur(10px);
                  display: flex;
                  align-items: center;
                  justify-content: center;
                  gap: 8px;
                  margin-bottom: 10px;
                ">
                  ‚ú® Perfect Fit
                </button>
                
                <p class="step-description" style="
                  font-size: 0.9rem;
                  color: #64748b;
                  line-height: 1.6;
                  margin: 0;
                  max-width: 90%;
                ">
                  Adjust your design to align perfectly within the print area.
                </p>
              </div>
              
              <!-- Step 3: Submit Request -->
              <div class="workflow-step step-3" style="
                width: 100%;
                display: flex;
                flex-direction: column;
                align-items: center;
                text-align: center;
              ">
                <div class="step-label" style="
                  font-size: 1rem;
                  font-weight: 700;
                  color: #dc2626;
                  text-transform: uppercase;
                  letter-spacing: 1.5px;
                  margin-bottom: 12px;
                  display: flex;
                  align-items: center;
                  gap: 8px;
                ">
                  <span style="
                    background: linear-gradient(135deg, #dc2626, #ef4444);
                    color: white;
                    width: 32px;
                    height: 32px;
                    border-radius: 50%;
                    display: inline-flex;
                    align-items: center;
                    justify-content: center;
                    font-weight: 800;
                    font-size: 16px;
                    box-shadow: 0 4px 12px rgba(220, 38, 38, 0.4);
                  ">3</span>
                  <span style="background: linear-gradient(135deg, #dc2626, #ef4444); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">Step 3</span>
                </div>
                
                <button class="nt-btn nt-btn--submit-request submit-request-hero-btn" id="nt-submit-request-btn-{{ section.id }}" style="
                  width: 100%;
                  padding: 20px 40px; 
                  border: 2px solid transparent; 
                  background: linear-gradient(135deg, #dc2626, #ef4444, #dc2626); 
                  background-size: 200% 200%;
                  color: white; 
                  border-radius: 20px; 
                  font-size: 18px; 
                  font-weight: 700; 
                  cursor: pointer; 
                  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); 
                  box-shadow: 0 8px 32px rgba(220, 38, 38, 0.4);
                  backdrop-filter: blur(10px);
                  -webkit-backdrop-filter: blur(10px);
                  position: relative;
                  overflow: hidden;
                  text-transform: uppercase;
                  letter-spacing: 1px;
                  animation: submit-pulse 2s ease-in-out infinite;
                  margin-bottom: 10px;
                ">
                  <span style="position: relative; z-index: 2; display: flex; align-items: center; justify-content: center; gap: 8px;">
                    üöÄ Submit Request
                  </span>
                  <div style="
                    position: absolute;
                    top: 0;
                    left: -100%;
                    width: 100%;
                    height: 100%;
                    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
                    transition: left 0.5s;
                  "></div>
                </button>
                
                <p class="step-description" style="
                  font-size: 0.9rem;
                  color: #64748b;
                  line-height: 1.6;
                  margin: 0;
                  max-width: 90%;
                ">
                  Send your finalized design for review or printing.
                </p>
              </div>
              
            </div>
            
          </div>
        </div>

        <!-- Customer Information Form (Hidden by default, shown when Submit Request is clicked) -->
        <div id="nt-submit-request-{{ section.id }}" style="display: none; margin-top: 40px; padding: 24px; background: linear-gradient(135deg, rgba(220, 38, 38, 0.1), rgba(239, 68, 68, 0.1)); border-radius: 16px; border: 2px solid rgba(220, 38, 38, 0.3); max-width: 600px; margin-left: auto; margin-right: auto;">
          <h4 style="margin: 0 0 16px 0; font-size: 18px; font-weight: 700; color: #dc2626; text-align: center;">üë§ Customer Information</h4>
          <p style="margin: 0 0 20px 0; font-size: 14px; color: #6b7280; text-align: center;">Please fill in your details to submit your custom t-shirt request</p>
          
          <form id="nt-request-form-{{ section.id }}" style="display: grid; gap: 12px;">
            <!-- Customer Details -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
              <div>
                <label style="display: block; margin-bottom: 4px; font-size: 12px; font-weight: 600; color: #374151;">Full Name *</label>
                <input type="text" id="nt-customer-name-{{ section.id }}" required 
                       style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 12px; background: white; box-sizing: border-box;">
              </div>
              <div>
                <label style="display: block; margin-bottom: 4px; font-size: 12px; font-weight: 600; color: #374151;">Email *</label>
                <input type="email" id="nt-customer-email-{{ section.id }}" required 
                       style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 12px; background: white; box-sizing: border-box;">
              </div>
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
              <div>
                <label style="display: block; margin-bottom: 4px; font-size: 12px; font-weight: 600; color: #374151;">Phone Number</label>
                <input type="tel" id="nt-customer-phone-{{ section.id }}" 
                       style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 12px; background: white; box-sizing: border-box;">
              </div>
              <div>
                <label style="display: block; margin-bottom: 4px; font-size: 12px; font-weight: 600; color: #374151;">T-Shirt Size</label>
                <select id="nt-tshirt-size-{{ section.id }}" 
                        style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 12px; background: white; box-sizing: border-box;">
                  <option value="">Select Size</option>
                  <option value="XXS">XXS</option>
                  <option value="XS">XS</option>
                  <option value="S">S</option>
                  <option value="M">M</option>
                  <option value="L">L</option>
                  <option value="XL">XL</option>
                  <option value="XXL">XXL</option>
                </select>
              </div>
            </div>
            
            <div>
              <label style="display: block; margin-bottom: 4px; font-size: 12px; font-weight: 600; color: #374151;">Special Instructions or Message</label>
              <textarea id="nt-customer-message-{{ section.id }}" rows="3" placeholder="Any special requirements, color preferences, or additional details..."
                        style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 12px; background: white; resize: vertical; box-sizing: border-box;"></textarea>
            </div>
            
            <!-- Submit Button -->
            <div style="display: flex; gap: 8px; justify-content: flex-end;">
              <button type="button" id="nt-cancel-request-{{ section.id }}" 
                      style="padding: 8px 16px; background: #6b7280; color: white; border: none; border-radius: 6px; font-size: 12px; cursor: pointer;">
                Cancel
              </button>
              <button type="submit" id="nt-submit-request-form-btn-{{ section.id }}" 
                      style="padding: 8px 16px; background: #dc2626; color: white; border: none; border-radius: 6px; font-size: 12px; cursor: pointer; font-weight: 600;">
                üöÄ Submit Request
              </button>
            </div>
          </form>
        </div>

      </div>
    </div>
  </div>

  <!-- ========================================
       ADVANCED EDIT MODAL WITH 7 TABS
       ======================================== -->
  <div id="edit-modal-{{ section.id }}" class="edit-modal" style="
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(15, 23, 42, 0.95);
    z-index: 10000;
    overflow-y: auto;
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
  ">
    <div class="edit-modal__container" style="
      max-width: 900px;
      margin: 40px auto;
      background: #ffffff;
      border-radius: 20px;
      box-shadow: 0 25px 80px rgba(39, 225, 193, 0.3);
      overflow: hidden;
    ">
      <!-- Modal Header -->
      <div class="edit-modal__header" style="
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 24px 32px;
        background: linear-gradient(135deg, #27e1c1 0%, #20b2aa 100%);
        color: #0f172a;
      ">
        <h2 style="margin: 0; font-size: 24px; font-weight: 700;">‚úèÔ∏è Advanced Editor</h2>
        <button id="edit-modal-close-{{ section.id }}" style="
          background: rgba(15, 23, 42, 0.2);
          border: none;
          color: #0f172a;
          width: 36px;
          height: 36px;
          border-radius: 50%;
          cursor: pointer;
          font-size: 20px;
          display: flex;
          align-items: center;
          justify-content: center;
          transition: all 0.2s;
        " onmouseover="this.style.background='rgba(15, 23, 42, 0.3)'" onmouseout="this.style.background='rgba(15, 23, 42, 0.2)'">
          ‚úï
        </button>
      </div>

      <!-- Tab Navigation -->
      <div class="edit-tabs" style="
        display: flex;
        gap: 8px;
        padding: 16px 24px;
        background: #f8fafc;
        border-bottom: 2px solid #e2e8f0;
        overflow-x: auto;
      ">
        <button class="edit-tab active" data-tab="transform" style="
          padding: 10px 16px;
          background: #27e1c1;
          color: #0f172a;
          border: none;
          border-radius: 10px;
          font-weight: 600;
          cursor: pointer;
          white-space: nowrap;
          transition: all 0.2s;
        ">Transform</button>
        <button class="edit-tab" data-tab="crop" style="
          padding: 10px 16px;
          background: transparent;
          color: #64748b;
          border: none;
          border-radius: 10px;
          font-weight: 600;
          cursor: pointer;
          white-space: nowrap;
          transition: all 0.2s;
        ">Crop</button>
        <button class="edit-tab" data-tab="background" style="
          padding: 10px 16px;
          background: transparent;
          color: #64748b;
          border: none;
          border-radius: 10px;
          font-weight: 600;
          cursor: pointer;
          white-space: nowrap;
          transition: all 0.2s;
        ">Background</button>
        <button class="edit-tab" data-tab="adjust" style="
          padding: 10px 16px;
          background: transparent;
          color: #64748b;
          border: none;
          border-radius: 10px;
          font-weight: 600;
          cursor: pointer;
          white-space: nowrap;
          transition: all 0.2s;
        ">Adjust</button>
        <button class="edit-tab" data-tab="warp" style="
          padding: 10px 16px;
          background: transparent;
          color: #64748b;
          border: none;
          border-radius: 10px;
          font-weight: 600;
          cursor: pointer;
          white-space: nowrap;
          transition: all 0.2s;
        ">Warp</button>
        <button class="edit-tab" data-tab="replace" style="
          padding: 10px 16px;
          background: transparent;
          color: #64748b;
          border: none;
          border-radius: 10px;
          font-weight: 600;
          cursor: pointer;
          white-space: nowrap;
          transition: all 0.2s;
        ">Replace</button>
        <button class="edit-tab" data-tab="quality" style="
          padding: 10px 16px;
          background: transparent;
          color: #64748b;
          border: none;
          border-radius: 10px;
          font-weight: 600;
          cursor: pointer;
          white-space: nowrap;
          transition: all 0.2s;
        ">Quality</button>
      </div>

      <!-- Tab Content -->
      <div class="edit-content" style="padding: 32px;">
        
        <!-- TRANSFORM TAB -->
        <div id="tab-transform-{{ section.id }}" class="edit-tab-content" style="display: block;">
          <h3 style="margin: 0 0 20px 0; font-size: 18px; color: #0f172a;">Transform Controls</h3>
          
          <!-- LIVE PREVIEW -->
          <div style="
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 24px;
            border: 2px solid #27e1c1;
          ">
            <h4 style="margin: 0 0 12px 0; font-size: 14px; font-weight: 600; color: #334155; text-align: center;">Live Preview</h4>
            <div id="edit-preview-{{ section.id }}" style="
              background: white;
              border-radius: 12px;
              min-height: 300px;
              display: flex;
              align-items: center;
              justify-content: center;
              position: relative;
              overflow: hidden;
            ">
              <!-- Preview will be cloned here -->
              <p style="color: #94a3b8; text-align: center;">Loading preview...</p>
            </div>
          </div>
          
          <div style="display: grid; gap: 20px;">
            <!-- Scale -->
            <div>
              <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #334155;">Scale (%)</label>
              <input type="number" id="scale-input-{{ section.id }}" min="1" max="500" value="100" style="
                width: 100%;
                padding: 12px;
                border: 2px solid #e2e8f0;
                border-radius: 10px;
                font-size: 14px;
              ">
            </div>

            <!-- Rotation -->
            <div>
              <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #334155;">Rotation (¬∞)</label>
              <input type="number" id="rotation-input-{{ section.id }}" min="-180" max="180" value="0" style="
                width: 100%;
                padding: 12px;
                border: 2px solid #e2e8f0;
                border-radius: 10px;
                font-size: 14px;
              ">
            </div>

            <!-- Flip & Position -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
              <button id="flip-h-btn-{{ section.id }}" style="
                padding: 12px;
                background: #f8fafc;
                border: 2px solid #e2e8f0;
                border-radius: 10px;
                font-weight: 600;
                cursor: pointer;
                transition: all 0.2s;
              " onmouseover="this.style.background='#27e1c1'; this.style.borderColor='#27e1c1'" 
                 onmouseout="this.style.background='#f8fafc'; this.style.borderColor='#e2e8f0'">
                ‚Üî Flip H
              </button>
              <button id="flip-v-btn-{{ section.id }}" style="
                padding: 12px;
                background: #f8fafc;
                border: 2px solid #e2e8f0;
                border-radius: 10px;
                font-weight: 600;
                cursor: pointer;
                transition: all 0.2s;
              " onmouseover="this.style.background='#27e1c1'; this.style.borderColor='#27e1c1'" 
                 onmouseout="this.style.background='#f8fafc'; this.style.borderColor='#e2e8f0'">
                ‚Üï Flip V
              </button>
            </div>

            <!-- Nudge Controls -->
            <div>
              <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #334155;">Nudge (Arrow Keys)</label>
              <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; max-width: 200px; margin: 0 auto;">
                <div></div>
                <button id="nudge-up-{{ section.id }}" style="padding: 10px; background: #f8fafc; border: 2px solid #e2e8f0; border-radius: 8px; cursor: pointer;">‚Üë</button>
                <div></div>
                <button id="nudge-left-{{ section.id }}" style="padding: 10px; background: #f8fafc; border: 2px solid #e2e8f0; border-radius: 8px; cursor: pointer;">‚Üê</button>
                <div></div>
                <button id="nudge-right-{{ section.id }}" style="padding: 10px; background: #f8fafc; border: 2px solid #e2e8f0; border-radius: 8px; cursor: pointer;">‚Üí</button>
                <div></div>
                <button id="nudge-down-{{ section.id }}" style="padding: 10px; background: #f8fafc; border: 2px solid #e2e8f0; border-radius: 8px; cursor: pointer;">‚Üì</button>
                <div></div>
              </div>
            </div>

            <!-- Quick Actions -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
              <button id="center-btn-{{ section.id }}" style="
                padding: 14px;
                background: #27e1c1;
                color: #0f172a;
                border: none;
                border-radius: 12px;
                font-weight: 700;
                cursor: pointer;
                transition: all 0.2s;
              " onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
                ‚äô Center
              </button>
              <button id="autofit-btn-{{ section.id }}" style="
                padding: 14px;
                background: #27e1c1;
                color: #0f172a;
                border: none;
                border-radius: 12px;
                font-weight: 700;
                cursor: pointer;
                transition: all 0.2s;
              " onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
                ‚ö° Auto-Fit
              </button>
            </div>
          </div>
        </div>

        <!-- CROP TAB -->
        <div id="tab-crop-{{ section.id }}" class="edit-tab-content" style="display: none;">
          <h3 style="margin: 0 0 20px 0; font-size: 18px; color: #0f172a;">Crop Tool</h3>
          <p style="color: #64748b; margin-bottom: 20px;">Click "Start Crop" to begin. Adjust the box, then click "Apply" to commit.</p>
          
          <div style="display: flex; gap: 12px;">
            <button id="crop-init-btn-{{ section.id }}" style="
              flex: 1;
              padding: 14px;
              background: #27e1c1;
              color: #0f172a;
              border: none;
              border-radius: 12px;
              font-weight: 700;
              cursor: pointer;
            ">‚úÇÔ∏è Start Crop</button>
            <button id="crop-apply-btn-{{ section.id }}" style="
              flex: 1;
              padding: 14px;
              background: #10b981;
              color: white;
              border: none;
              border-radius: 12px;
              font-weight: 700;
              cursor: pointer;
              opacity: 0.5;
            " disabled>‚úì Apply</button>
            <button id="crop-cancel-btn-{{ section.id }}" style="
              flex: 1;
              padding: 14px;
              background: #ef4444;
              color: white;
              border: none;
              border-radius: 12px;
              font-weight: 700;
              cursor: pointer;
              opacity: 0.5;
            " disabled>‚úï Cancel</button>
          </div>
        </div>

        <!-- BACKGROUND TAB -->
        <div id="tab-background-{{ section.id }}" class="edit-tab-content" style="display: none;">
          <h3 style="margin: 0 0 20px 0; font-size: 18px; color: #0f172a;">Background Removal</h3>
          
          <div style="display: grid; gap: 20px;">
            <div>
              <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #334155;">Target Color</label>
              <input type="color" id="bg-color-{{ section.id }}" value="#ffffff" style="
                width: 100%;
                height: 50px;
                border: 2px solid #e2e8f0;
                border-radius: 10px;
                cursor: pointer;
              ">
            </div>

            <div>
              <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #334155;">Tolerance: <span id="tolerance-value-{{ section.id }}">30</span></label>
              <input type="range" id="bg-tolerance-{{ section.id }}" min="0" max="100" value="30" style="
                width: 100%;
              ">
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
              <button id="remove-bg-btn-{{ section.id }}" style="
                padding: 14px;
                background: #27e1c1;
                color: #0f172a;
                border: none;
                border-radius: 12px;
                font-weight: 700;
                cursor: pointer;
              ">üé® Remove BG</button>
              <button id="revert-bg-btn-{{ section.id }}" style="
                padding: 14px;
                background: #f59e0b;
                color: white;
                border: none;
                border-radius: 12px;
                font-weight: 700;
                cursor: pointer;
              ">‚Ü∂ Revert BG</button>
            </div>
          </div>
        </div>

        <!-- ADJUST TAB -->
        <div id="tab-adjust-{{ section.id }}" class="edit-tab-content" style="display: none;">
          <h3 style="margin: 0 0 20px 0; font-size: 18px; color: #0f172a;">Image Adjustments</h3>
          
          <div style="display: grid; gap: 20px;">
            <!-- Opacity -->
            <div>
              <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #334155;">Opacity: <span id="opacity-value-{{ section.id }}">100</span>%</label>
              <input type="range" id="opacity-slider-{{ section.id }}" min="0" max="100" value="100" style="width: 100%;">
            </div>

            <!-- Brightness -->
            <div>
              <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #334155;">Brightness: <span id="brightness-value-{{ section.id }}">0</span></label>
              <input type="range" id="brightness-slider-{{ section.id }}" min="-1" max="1" step="0.1" value="0" style="width: 100%;">
            </div>

            <!-- Contrast -->
            <div>
              <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #334155;">Contrast: <span id="contrast-value-{{ section.id }}">0</span></label>
              <input type="range" id="contrast-slider-{{ section.id }}" min="-1" max="1" step="0.1" value="0" style="width: 100%;">
            </div>

            <!-- Grayscale -->
            <div>
              <label style="display: flex; align-items: center; gap: 12px; cursor: pointer;">
                <input type="checkbox" id="grayscale-check-{{ section.id }}" style="width: 20px; height: 20px; cursor: pointer;">
                <span style="font-weight: 600; color: #334155;">Grayscale</span>
              </label>
            </div>

            <!-- Outline -->
            <div>
              <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #334155;">Outline Width: <span id="outline-value-{{ section.id }}">0</span>px</label>
              <input type="range" id="outline-slider-{{ section.id }}" min="0" max="20" value="0" style="width: 100%;">
            </div>
          </div>
        </div>

        <!-- WARP TAB -->
        <div id="tab-warp-{{ section.id }}" class="edit-tab-content" style="display: none;">
          <h3 style="margin: 0 0 20px 0; font-size: 18px; color: #0f172a;">Perspective Warp</h3>
          <p style="color: #64748b; margin-bottom: 20px;">üöß Advanced perspective warping coming soon! This will allow 4-corner distortion for creative effects.</p>
          
          <button style="
            padding: 14px;
            background: #94a3b8;
            color: white;
            border: none;
            border-radius: 12px;
            font-weight: 700;
            cursor: not-allowed;
            width: 100%;
          " disabled>üîß Enable Warp (Coming Soon)</button>
        </div>

        <!-- REPLACE TAB -->
        <div id="tab-replace-{{ section.id }}" class="edit-tab-content" style="display: none;">
          <h3 style="margin: 0 0 20px 0; font-size: 18px; color: #0f172a;">Replace Design</h3>
          <p style="color: #64748b; margin-bottom: 20px;">Upload a new image while preserving position, scale, and rotation.</p>
          
          <div style="
            border: 3px dashed #e2e8f0;
            border-radius: 12px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
          " id="replace-dropzone-{{ section.id }}"
             onmouseover="this.style.borderColor='#27e1c1'; this.style.background='#f0fdfa'" 
             onmouseout="this.style.borderColor='#e2e8f0'; this.style.background='transparent'">
            <div style="font-size: 48px; margin-bottom: 12px;">üìÅ</div>
            <p style="margin: 0; font-weight: 600; color: #334155;">Click or drag to replace design</p>
            <input type="file" id="replace-input-{{ section.id }}" accept="image/*" style="display: none;">
          </div>
        </div>

        <!-- QUALITY TAB -->
        <div id="tab-quality-{{ section.id }}" class="edit-tab-content" style="display: none;">
          <h3 style="margin: 0 0 20px 0; font-size: 18px; color: #0f172a;">Print Quality Analysis</h3>
          
          <div style="
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            border-radius: 16px;
            padding: 24px;
            text-align: center;
          ">
            <div style="font-size: 64px; font-weight: 900; margin-bottom: 12px;" id="dpi-display-{{ section.id }}">
              <span id="dpi-number-{{ section.id }}" style="color: #27e1c1;">300</span>
              <span style="font-size: 24px; color: #64748b;">DPI</span>
            </div>
            
            <div style="
              padding: 12px 24px;
              background: #27e1c1;
              color: #0f172a;
              border-radius: 12px;
              font-weight: 700;
              display: inline-block;
              margin-bottom: 16px;
            " id="quality-badge-{{ section.id }}">
              ‚úì EXCELLENT QUALITY
            </div>

            <p style="color: #64748b; margin: 0; font-size: 14px;">
              <strong>Tip:</strong> Aim for ‚â•300 DPI for best print results
            </p>
          </div>

          <div style="
            margin-top: 20px;
            padding: 16px;
            background: #fef3c7;
            border-left: 4px solid #f59e0b;
            border-radius: 8px;
          " id="quality-warning-{{ section.id }}" style="display: none;">
            <strong>‚ö†Ô∏è Warning:</strong> Your design may appear pixelated when printed. Consider uploading a higher resolution image.
          </div>
        </div>

      </div>

      <!-- Modal Footer -->
      <div class="edit-modal__footer" style="
        display: flex;
        justify-content: flex-end;
        gap: 12px;
        padding: 24px 32px;
        background: #f8fafc;
        border-top: 2px solid #e2e8f0;
      ">
        <button id="edit-done-btn-{{ section.id }}" style="
          padding: 14px 32px;
          background: #27e1c1;
          color: #0f172a;
          border: none;
          border-radius: 12px;
          font-weight: 700;
          font-size: 16px;
          cursor: pointer;
          transition: all 0.2s;
        " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 8px 20px rgba(39, 225, 193, 0.4)'" 
           onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
          ‚úì Done Editing
        </button>
      </div>
    </div>
  </div>

</div>

<!-- Load Studio Edit Operations -->
<script src="{{ 'studio-edit.js' | asset_url }}" defer></script>

<script>
function closeCustomStudio() {
  // Hide the custom studio section
  const studio = document.getElementById('custom-tshirt-studio-{{ section.id }}');
  if (studio) {
    studio.style.display = 'none';
  }
  
  // Show the main page content again
  const mainContent = document.querySelector('.main-content');
  if (mainContent) {
    mainContent.style.display = 'block';
  }
  
  // Scroll to top
  window.scrollTo({ top: 0, behavior: 'smooth' });
}

// Show custom studio function (called from home page button)
window.openCustomDesignStudio = function() {
  // Hide main content
  const mainContent = document.querySelector('.main-content');
  if (mainContent) {
    mainContent.style.display = 'none';
  }
  
  // Show the custom studio
  const studio = document.getElementById('custom-tshirt-studio-{{ section.id }}');
  if (studio) {
    studio.style.display = 'block';
    studio.scrollIntoView({ behavior: 'smooth' });
    
    // Initialize the mockup and size chart after the studio is visible
    setTimeout(() => {
      console.log('üé® Studio opened, initializing mockup and size chart...');
      initializeMockup();
      
      // Initialize size chart
      if (typeof initializeSizeChart === 'function') {
        initializeSizeChart();
      } else {
        console.error('‚ùå initializeSizeChart function not found');
      }
    }, 200);
  }
};

// Also make it available as showCustomStudio for compatibility
window.showCustomStudio = window.openCustomDesignStudio;

// PRESERVE ALL OUR CURRENT WORKING JAVASCRIPT FUNCTIONALITY
function initializeMockup() {
  const mockup = {
    // Mockup images mapping - using tshirt-view.png as the base template
    mockupImages: {
      front: {
        white: "{{ 'tshirt-view.png' | asset_url }}",
        black: "{{ 'tshirt-view.png' | asset_url }}",
        red: "{{ 'tshirt-view.png' | asset_url }}",
        blue: "{{ 'tshirt-view.png' | asset_url }}"
      },
      back: {
        white: "{{ 'tshirt-view.png' | asset_url }}",
        black: "{{ 'tshirt-view.png' | asset_url }}",
        red: "{{ 'tshirt-view.png' | asset_url }}",
        blue: "{{ 'tshirt-view.png' | asset_url }}"
      },
      hanging: {
        white: "{{ 'tshirt-view.png' | asset_url }}",
        black: "{{ 'tshirt-view.png' | asset_url }}",
        red: "{{ 'tshirt-view.png' | asset_url }}",
        blue: "{{ 'tshirt-view.png' | asset_url }}"
      },
      person1: {
        white: "{{ 'Girl-Model.png' | asset_url }}",
        black: "{{ 'Girl-Model.png' | asset_url }}",
        red: "{{ 'Girl-Model.png' | asset_url }}",
        blue: "{{ 'Girl-Model.png' | asset_url }}"
      },
      person2: {
        white: "{{ 'Women-side.png' | asset_url }}",
        black: "{{ 'Women-side.png' | asset_url }}",
        red: "{{ 'Women-side.png' | asset_url }}",
        blue: "{{ 'Women-side.png' | asset_url }}"
      }
    },
    
    // Current base mockup image - using tshirt-view.png as the default template
    baseMockup: "{{ 'tshirt-view.png' | asset_url }}",

    // Current design state
    designState: {
      text: 'Your Design Here',
      fontSize: 32,
      fontFamily: "'Bebas Neue', sans-serif",
      textColor: '#000000',
      shirtColor: 'white',
      effect: 'none'
    },

    // Current view state
    state: { view: "front", color: "white" },

    // Enhanced placement state - aligned with print area
    placementState: {
      topPct: 30,   // Adjusted to match print area top
      leftPct: 50,  // Centered horizontally
      widthPct: 50, // Adjusted to match print area width
      heightPct: 65, // Adjusted to match print area height (rectangular)
      rotateDeg: 0,
      dragging: false,
      resizing: false,
      resizeDirection: 'se',
      lastX: 0,
      lastY: 0,
      hasUploadedDesign: false,
      designSelected: false,
      zoomLevel: 1.0, // Zoom level (1.0 = 100%)
      baseWidthPct: 50, // Original width for zoom calculations
      baseHeightPct: 65 // Original height for zoom calculations
    },

    init() {
      console.log('üéØ Initializing Custom Studio Mockup...');
      this.bindEvents();
      this.bindDragResize();
      this.bindMouseWheelResize();
      this.bindKeyboardShortcuts();
      this.bindZoomControls();
      this.updateBase();
      this.updateDesign();
      this.updatePlacementDisplay();
      this.updateDesignPosition();
      this.updateZoomLevelDisplay();
      console.log('‚úÖ Custom Studio Mockup initialized');
    },

    setActive(buttons, activeValue) {
      buttons.forEach(btn => {
        btn.classList.remove('is-active');
        if (btn.dataset.view === activeValue || btn.dataset.color === activeValue) {
          btn.classList.add('is-active');
        }
      });
    },

    updateBase() {
      const baseImg = document.getElementById('nt-base-{{ section.id }}');
      if (!baseImg) return;
      
      const imageSrc = this.mockupImages[this.state.view]?.[this.state.color] || this.baseMockup;
      baseImg.src = imageSrc;
    },

    updateDesign() {
      // Update design display if needed
    },

    updatePlacementDisplay() {
      // Update placement display controls
      const topSlider = document.getElementById(`nt-placement-top-{{ section.id }}`);
      const leftSlider = document.getElementById(`nt-placement-left-{{ section.id }}`);
      const widthSlider = document.getElementById(`nt-placement-width-{{ section.id }}`);
      const heightSlider = document.getElementById(`nt-placement-height-{{ section.id }}`);
      const rotationSlider = document.getElementById(`nt-placement-rotation-{{ section.id }}`);

      if (topSlider) topSlider.value = this.placementState.topPct;
      if (leftSlider) leftSlider.value = this.placementState.leftPct;
      if (widthSlider) widthSlider.value = this.placementState.widthPct;
      if (heightSlider) heightSlider.value = this.placementState.heightPct;
      if (rotationSlider) rotationSlider.value = this.placementState.rotateDeg;
    },

    updateDesignPosition() {
      const overlay = document.getElementById('nt-overlay-{{ section.id }}');
      if (!overlay) return;

      // Apply the placement state to the overlay
      overlay.style.top = this.placementState.topPct + '%';
      overlay.style.left = this.placementState.leftPct + '%';
      overlay.style.width = this.placementState.widthPct + '%';
      overlay.style.height = this.placementState.heightPct + '%';
      overlay.style.transform = `translateX(-50%) rotate(${this.placementState.rotateDeg}deg)`;
    },

    selectDesign() {
      this.placementState.designSelected = true;
      const overlay = document.getElementById('nt-overlay-{{ section.id }}');
      if (overlay) {
        overlay.style.borderColor = '#3b82f6';
        overlay.style.boxShadow = '0 0 0 2px rgba(59, 130, 246, 0.3)';
        
        // Show resize handles
        const resizeHandles = overlay.querySelectorAll('.resize-handle');
        resizeHandles.forEach(handle => {
          handle.style.display = 'block';
        });
      }
    },

    deselectDesign() {
      this.placementState.designSelected = false;
      const overlay = document.getElementById('nt-overlay-{{ section.id }}');
      if (overlay) {
        overlay.style.borderColor = 'rgba(39, 225, 193, 0.3)';
        overlay.style.boxShadow = 'inset 0 4px 12px rgba(0, 0, 0, 0.1)';
        
        // Hide resize handles
        const resizeHandles = overlay.querySelectorAll('.resize-handle');
        resizeHandles.forEach(handle => {
          handle.style.display = 'none';
        });
      }
    },

    startDrag(e) {
      this.placementState.dragging = true;
      this.placementState.lastX = e.clientX;
      this.placementState.lastY = e.clientY;
      
      const overlay = document.getElementById('nt-overlay-{{ section.id }}');
      if (overlay) {
        overlay.style.cursor = 'grabbing';
      }
      
      document.addEventListener('mousemove', this.handleDrag);
      document.addEventListener('mouseup', this.stopDrag);
    },

    handleDrag(e) {
      if (!this.placementState.dragging) return;
      
      const deltaX = e.clientX - this.placementState.lastX;
      const deltaY = e.clientY - this.placementState.lastY;
      
      const canvas = document.getElementById('nt-mockup-canvas-{{ section.id }}');
      if (canvas) {
        const rect = canvas.getBoundingClientRect();
        const deltaXPercent = (deltaX / rect.width) * 100;
        const deltaYPercent = (deltaY / rect.height) * 100;
        
        this.placementState.leftPct += deltaXPercent;
        this.placementState.topPct += deltaYPercent;
        
        // Constrain to canvas bounds
        this.placementState.leftPct = Math.max(0, Math.min(100, this.placementState.leftPct));
        this.placementState.topPct = Math.max(0, Math.min(100, this.placementState.topPct));
        
        this.updateDesignPosition();
      }
      
      this.placementState.lastX = e.clientX;
      this.placementState.lastY = e.clientY;
    },

    stopDrag() {
      this.placementState.dragging = false;
      
      const overlay = document.getElementById('nt-overlay-{{ section.id }}');
      if (overlay) {
        overlay.style.cursor = 'grab';
      }
      
      document.removeEventListener('mousemove', this.handleDrag);
      document.removeEventListener('mouseup', this.stopDrag);
    },

    startResize(e, direction) {
      this.placementState.resizing = true;
      this.placementState.resizeDirection = direction;
      this.placementState.lastX = e.clientX;
      this.placementState.lastY = e.clientY;

      const handleResize = (e) => {
        if (!this.placementState.resizing) return;
        
        const deltaX = e.clientX - this.placementState.lastX;
        const deltaY = e.clientY - this.placementState.lastY;
          
        this.resizeDesignByDirection(direction, deltaX, deltaY);
        
        this.placementState.lastX = e.clientX;
        this.placementState.lastY = e.clientY;
      };

      const stopResize = () => {
        this.placementState.resizing = false;
        document.removeEventListener('mousemove', handleResize);
        document.removeEventListener('mouseup', stopResize);
      };

      document.addEventListener('mousemove', handleResize);
      document.addEventListener('mouseup', stopResize);
    },

    resizeDesignByDirection(direction, deltaX, deltaY) {
      const sensitivity = 0.5;
      
      switch (direction) {
        case 'nw':
          this.placementState.topPct += deltaY * sensitivity;
          this.placementState.leftPct += deltaX * sensitivity;
          this.placementState.widthPct -= deltaX * sensitivity;
          this.placementState.heightPct -= deltaY * sensitivity;
          break;
        case 'ne':
          this.placementState.topPct += deltaY * sensitivity;
          this.placementState.widthPct += deltaX * sensitivity;
          this.placementState.heightPct -= deltaY * sensitivity;
          break;
        case 'sw':
          this.placementState.leftPct += deltaX * sensitivity;
          this.placementState.widthPct -= deltaX * sensitivity;
          this.placementState.heightPct += deltaY * sensitivity;
          break;
        case 'se':
          this.placementState.widthPct += deltaX * sensitivity;
          this.placementState.heightPct += deltaY * sensitivity;
          break;
        case 'n':
          this.placementState.topPct += deltaY * sensitivity;
          this.placementState.heightPct -= deltaY * sensitivity;
          break;
        case 's':
          this.placementState.heightPct += deltaY * sensitivity;
          break;
        case 'w':
          this.placementState.leftPct += deltaX * sensitivity;
          this.placementState.widthPct -= deltaX * sensitivity;
          break;
        case 'e':
          this.placementState.widthPct += deltaX * sensitivity;
          break;
      }

      // Constrain values
      this.placementState.topPct = Math.max(0, Math.min(100, this.placementState.topPct));
      this.placementState.leftPct = Math.max(0, Math.min(100, this.placementState.leftPct));
      this.placementState.widthPct = Math.max(10, Math.min(90, this.placementState.widthPct));
      this.placementState.heightPct = Math.max(10, Math.min(90, this.placementState.heightPct));
        
      this.updatePlacementDisplay();
      this.updateDesignPosition();
    },

    // Enhanced resize functionality for easier use
    resizeDesign(delta) {
      this.placementState.widthPct += delta;
      this.placementState.heightPct += delta;
      
      // Constrain values
      this.placementState.widthPct = Math.max(10, Math.min(90, this.placementState.widthPct));
      this.placementState.heightPct = Math.max(10, Math.min(90, this.placementState.heightPct));
      
      this.updatePlacementDisplay();
      this.updateDesignPosition();
    },

    // Add mouse wheel resizing for easier control
    bindMouseWheelResize() {
      const overlay = document.getElementById('nt-overlay-{{ section.id }}');
      if (!overlay) return;

      let isOverOverlay = false;
      
      overlay.addEventListener('mouseenter', () => {
        isOverOverlay = true;
      });
      
      overlay.addEventListener('mouseleave', () => {
        isOverOverlay = false;
      });

      // Mouse wheel resize - ONLY when hovering over the overlay
      document.addEventListener('wheel', (e) => {
        if (isOverOverlay && this.placementState.hasUploadedDesign) {
          e.preventDefault();
          // Reduced sensitivity for better control
          const delta = e.deltaY > 0 ? -1 : 1;
          this.resizeDesign(delta);
        }
      }, { passive: false });
    },

    // Add keyboard shortcuts for precise control
    bindKeyboardShortcuts() {
      document.addEventListener('keydown', (e) => {
        // Arrow key movement only works with uploaded design
        const hasDesign = this.placementState.hasUploadedDesign && this.placementState.designSelected;
        
        // Zoom shortcuts work always
        if (e.key === '+' || e.key === '=' || e.key === '-' || (e.key === '0' && e.shiftKey)) {
          e.preventDefault();
          switch (e.key) {
            case '+':
            case '=':
              if (e.shiftKey) {
                this.zoomIn(); // Shift+Plus = Canvas Zoom In
              } else if (hasDesign) {
                this.resizeDesign(1); // Regular Plus = Resize Design
              }
              break;
            case '-':
              if (e.shiftKey) {
                this.zoomOut(); // Shift+Minus = Canvas Zoom Out
              } else if (hasDesign) {
                this.resizeDesign(-1); // Regular Minus = Resize Design
              }
              break;
            case '0':
              if (e.shiftKey) {
                this.resetZoom(); // Shift+0 = Reset Canvas Zoom
              }
              break;
          }
          return;
        }
        
        // Arrow key movement requires uploaded design
        if (!hasDesign) return;
        
        // Ultra-precise movement with different step sizes
        let step = 0.5; // Default: ultra-precise (0.5px)
        if (e.shiftKey) step = 2; // Shift: medium steps (2px)
        if (e.ctrlKey) step = 0.1; // Ctrl: micro-precise (0.1px)
        if (e.shiftKey && e.ctrlKey) step = 5; // Shift+Ctrl: large steps (5px)
        
        switch (e.key) {
          case 'ArrowUp':
            e.preventDefault();
            this.placementState.topPct = Math.max(0, this.placementState.topPct - step);
            this.updatePlacementDisplay();
            this.updateDesignPosition();
            this.showMessage(`‚¨ÜÔ∏è Design moved up ${step}px`, 'info');
            break;
          case 'ArrowDown':
            e.preventDefault();
            this.placementState.topPct = Math.min(100, this.placementState.topPct + step);
            this.updatePlacementDisplay();
            this.updateDesignPosition();
            this.showMessage(`‚¨áÔ∏è Design moved down ${step}px`, 'info');
            break;
          case 'ArrowLeft':
            e.preventDefault();
            this.placementState.leftPct = Math.max(0, this.placementState.leftPct - step);
            this.updatePlacementDisplay();
            this.updateDesignPosition();
            this.showMessage(`‚¨ÖÔ∏è Design moved left ${step}px`, 'info');
            break;
          case 'ArrowRight':
            e.preventDefault();
            this.placementState.leftPct = Math.min(100, this.placementState.leftPct + step);
            this.updatePlacementDisplay();
            this.updateDesignPosition();
            this.showMessage(`‚û°Ô∏è Design moved right ${step}px`, 'info');
            break;
        }
      });
    },

    // Zoom functionality for design studio - zooms the entire canvas view
    zoomIn() {
      const newZoom = Math.min(this.placementState.zoomLevel + 0.2, 3.0); // Max 300%
      this.setZoom(newZoom);
      this.showMessage(`üîç+ Canvas zoomed in to ${Math.round(newZoom * 100)}%`, 'success');
    },

    zoomOut() {
      const newZoom = Math.max(this.placementState.zoomLevel - 0.2, 0.2); // Min 20%
      this.setZoom(newZoom);
      this.showMessage(`üîç- Canvas zoomed out to ${Math.round(newZoom * 100)}%`, 'success');
    },

    resetZoom() {
      this.setZoom(1.0);
      this.showMessage('üéØ Canvas zoom reset to 100%', 'success');
    },

    setZoom(zoomLevel) {
      this.placementState.zoomLevel = zoomLevel;
      
      // Apply zoom to the entire canvas container
      const canvas = document.getElementById('nt-mockup-canvas-{{ section.id }}');
      const mockupContainer = document.getElementById('nt-mockup-{{ section.id }}');
      
      if (canvas && mockupContainer) {
        // Apply CSS transform to zoom the entire canvas with smooth transition
        canvas.style.transition = 'transform 0.3s ease, border-color 0.3s ease';
        canvas.style.transform = `scale(${zoomLevel})`;
        canvas.style.transformOrigin = 'center center';
        
        // Adjust container size to accommodate zoom
        const containerPadding = 20; // Extra space around zoomed canvas
        mockupContainer.style.padding = `${containerPadding}px`;
        
        // Update canvas container to show zoom level visually
        canvas.style.border = `3px solid ${zoomLevel > 1 ? '#10b981' : zoomLevel < 1 ? '#ef4444' : '#6b7280'}`;
        canvas.style.borderRadius = '12px';
        
        // Add zoom indicator overlay
        this.updateZoomIndicator(zoomLevel);
      }
      
      // Update display
      this.updateZoomLevelDisplay();
    },

    updateZoomIndicator(zoomLevel) {
      // Remove existing zoom indicator
      const existingIndicator = document.getElementById('nt-zoom-indicator-{{ section.id }}');
      if (existingIndicator) {
        existingIndicator.remove();
      }
      
      // Add zoom indicator overlay
      const canvas = document.getElementById('nt-mockup-canvas-{{ section.id }}');
      if (canvas && zoomLevel !== 1.0) {
        const indicator = document.createElement('div');
        indicator.id = 'nt-zoom-indicator-{{ section.id }}';
        indicator.style.cssText = `
          position: absolute;
          top: 10px;
          right: 10px;
          background: ${zoomLevel > 1 ? 'rgba(16, 185, 129, 0.9)' : 'rgba(239, 68, 68, 0.9)'};
          color: white;
          padding: 8px 12px;
          border-radius: 20px;
          font-size: 12px;
          font-weight: 600;
          z-index: 1000;
          box-shadow: 0 4px 12px rgba(0,0,0,0.2);
          backdrop-filter: blur(10px);
          -webkit-backdrop-filter: blur(10px);
        `;
        indicator.textContent = `${Math.round(zoomLevel * 100)}%`;
        canvas.appendChild(indicator);
        
        // Auto-hide indicator after 3 seconds
        setTimeout(() => {
          if (indicator.parentNode) {
            indicator.style.opacity = '0';
            indicator.style.transition = 'opacity 0.5s ease';
            setTimeout(() => {
              if (indicator.parentNode) {
                indicator.remove();
              }
            }, 500);
          }
        }, 3000);
      }
    },

    updateZoomLevelDisplay() {
      const zoomDisplay = document.getElementById(`nt-zoom-level-{{ section.id }}`);
      if (zoomDisplay) {
        zoomDisplay.textContent = `Zoom: ${Math.round(this.placementState.zoomLevel * 100)}%`;
      }
    },

    bindZoomControls() {
      // Zoom In button
      // Zoom Slider (replaces old +/- buttons)
      const zoomRange = document.getElementById(`nt-zoom-range-{{ section.id }}`);
      const zoomLabel = document.getElementById(`nt-zoom-label-{{ section.id }}`);
      
      if (zoomRange && zoomLabel) {
        // Update zoom when slider changes
        zoomRange.addEventListener('input', (e) => {
          const percent = parseInt(e.target.value, 10);
          const scale = percent / 100;
          this.setZoom(scale);
          zoomLabel.textContent = `${percent}%`;
        });
        
        // Keyboard shortcuts for zoom (+ and -)
        document.addEventListener('keydown', (e) => {
          if ((e.key === '+' || e.key === '=') && !this.isInputFocused()) {
            e.preventDefault();
            const currentPercent = parseInt(zoomRange.value, 10);
            const newPercent = Math.min(200, currentPercent + 10);
            zoomRange.value = newPercent;
            const scale = newPercent / 100;
            this.setZoom(scale);
            zoomLabel.textContent = `${newPercent}%`;
          }
          if (e.key === '-' && !this.isInputFocused()) {
            e.preventDefault();
            const currentPercent = parseInt(zoomRange.value, 10);
            const newPercent = Math.max(50, currentPercent - 10);
            zoomRange.value = newPercent;
            const scale = newPercent / 100;
            this.setZoom(scale);
            zoomLabel.textContent = `${newPercent}%`;
          }
        });
        
        // Update slider when zoom changes programmatically
        window.addEventListener('canvas:zoomchange', (e) => {
          if (e && e.detail && typeof e.detail.scale === 'number') {
            const percent = Math.round(e.detail.scale * 100);
            zoomRange.value = percent;
            zoomLabel.textContent = `${percent}%`;
          }
        });
        
        console.log('‚úÖ Zoom slider initialized');
      }
    },
    
    // Helper to check if an input is focused (for keyboard shortcuts)
    isInputFocused() {
      const activeEl = document.activeElement;
      return activeEl && (activeEl.tagName === 'INPUT' || activeEl.tagName === 'TEXTAREA' || activeEl.tagName === 'SELECT');
    },

    // Bind drag functionality to overlay
    bindDragResize() {
      const overlay = document.getElementById('nt-overlay-{{ section.id }}');
      const canvas = document.getElementById('nt-mockup-canvas-{{ section.id }}');
      
      if (!overlay || !canvas) return;
      
      // Bind the drag functions to this context
      this.handleDrag = this.handleDrag.bind(this);
      this.stopDrag = this.stopDrag.bind(this);
      
      overlay.addEventListener('mousedown', (e) => {
        e.stopPropagation();
        this.startDrag(e);
      });

      // Bind resize handles
      const resizeHandles = document.querySelectorAll(`#nt-overlay-{{ section.id }} .resize-handle`);
      resizeHandles.forEach(handle => {
        handle.addEventListener('mousedown', (e) => {
          e.preventDefault();
          e.stopPropagation();
          this.startResize(e, handle.dataset.direction);
        });
      });
      
      overlay.addEventListener('click', (e) => {
        e.stopPropagation();
        this.selectDesign();
      });
      
      canvas.addEventListener('click', (e) => {
        if (e.target === canvas) {
          this.deselectDesign();
        }
      });
    },

    bindEvents() {
      const rootId = "nt-mockup-{{ section.id }}";
      
      // View buttons
      const viewBtns = Array.from(document.querySelectorAll(`#${rootId} .nt-btn--view`));
      viewBtns.forEach(btn => {
        btn.addEventListener("click", () => {
          this.state.view = btn.dataset.view;
          this.setActive(viewBtns, this.state.view);
          this.updateBase();
          console.log('üëÅÔ∏è View changed to:', this.state.view);
        });
      });

      // Color buttons
      const colorBtns = Array.from(document.querySelectorAll(`#${rootId} .nt-btn--color`));
      colorBtns.forEach(btn => {
        btn.addEventListener("click", () => {
          this.state.color = btn.dataset.color;
          this.setActive(colorBtns, this.state.color);
          this.updateBase();
          console.log('üé® Color changed to:', this.state.color);
        });
      });

      // Upload button
      const uploadBtn = document.getElementById(`nt-upload-{{ section.id }}`);
      if (uploadBtn) {
        uploadBtn.addEventListener("click", (e) => {
          console.log('üìÅ Upload button clicked');
          const input = document.createElement('input');
          input.type = 'file';
          input.accept = 'image/*';
          input.onchange = (e) => {
            const file = e.target.files[0];
            if (file) {
              this.handleFileUpload(file);
            }
          };
          input.click();
        });
      }

      // Download button
      const downloadBtn = document.getElementById(`nt-download-{{ section.id }}`);
      if (downloadBtn) {
        downloadBtn.addEventListener("click", () => {
          console.log('üíæ Download button clicked');
          this.downloadMockup();
        });
      }

      // Edit button - handled by initEditModal() function below
      // const editBtn = document.getElementById(`nt-edit-{{ section.id }}`);
      // Removed old "coming soon" alert - now opens advanced Edit Modal

      // Remove button
      const removeBtn = document.getElementById(`nt-remove-{{ section.id }}`);
      if (removeBtn) {
        removeBtn.addEventListener("click", () => {
          console.log('üóëÔ∏è Remove button clicked');
          this.removeDesign();
        });
      }

      // Placement Guide button
      this.bindPlacementGuide();

      // Perfect Fit button
      const perfectFitBtn = document.getElementById(`nt-perfect-fit-btn-{{ section.id }}`);
      if (perfectFitBtn) {
        perfectFitBtn.addEventListener("click", () => {
          console.log('üéØ Perfect Fit button clicked');
          this.perfectFit();
        });
      }

      // Submit Request button (shows the customer form)
      const submitBtn = document.getElementById(`nt-submit-request-btn-{{ section.id }}`);
      if (submitBtn) {
        submitBtn.addEventListener("click", () => {
          console.log('üöÄ Submit Request button clicked');
          this.submitRequest();
        });
      }

      // Customer form submit
      const requestForm = document.getElementById(`nt-request-form-{{ section.id }}`);
      if (requestForm) {
        requestForm.addEventListener('submit', (e) => {
          e.preventDefault();
          this.submitTShirtRequest();
        });
      }

      // Cancel button
      const cancelBtn = document.getElementById(`nt-cancel-request-{{ section.id }}`);
      if (cancelBtn) {
        cancelBtn.addEventListener('click', () => {
          document.getElementById(`nt-submit-request-{{ section.id }}`).style.display = 'none';
          this.resetRequestForm();
        });
      }

      // 3D Controls
      const rotateBtn = document.getElementById(`nt-3d-rotate-{{ section.id }}`);
      if (rotateBtn) {
        rotateBtn.addEventListener("click", () => {
          console.log('‚Ü∫ Rotate button clicked');
          this.rotateDesign();
        });
      }

      const zoomBtn = document.getElementById(`nt-zoom-{{ section.id }}`);
      if (zoomBtn) {
        zoomBtn.addEventListener("click", () => {
          console.log('üîç Zoom button clicked');
          this.zoomDesign();
        });
      }

      const validateBtn = document.getElementById(`nt-validate-{{ section.id }}`);
      if (validateBtn) {
        validateBtn.addEventListener("click", () => {
          console.log('‚úÖ Validate button clicked');
          this.validateDesign();
        });
      }

      const resetBtn = document.getElementById(`nt-reset-{{ section.id }}`);
      if (resetBtn) {
        resetBtn.addEventListener("click", () => {
          console.log('üîÑ Reset button clicked');
          this.resetDesign();
        });
      }
    },
    
    handleFileUpload(file) {
      console.log('üì§ Processing file:', file.name, file.type, file.size);
      
      const allowedTypes = ['image/png', 'image/jpeg', 'image/jpg', 'image/svg+xml'];
      if (!allowedTypes.includes(file.type)) {
        this.showMessage('‚ùå Invalid file type. Please upload PNG, JPG, or SVG files.', 'error');
        return;
      }
      
      const maxSize = 10 * 1024 * 1024;
      if (file.size > maxSize) {
        this.showMessage('‚ùå File too large. Please upload files smaller than 10MB.', 'error');
        return;
      }
      
      this.showMessage('üìÅ Processing your design...', 'info');
      
      const reader = new FileReader();
      reader.onload = (e) => {
        console.log('‚úÖ File loaded, applying to mockup');
        this.applyUploadedDesign(e.target.result);
      };
      reader.readAsDataURL(file);
    },

    applyUploadedDesign(imageData) {
      console.log('üé® Applying design to mockup');
      
      const overlayDiv = document.getElementById(`nt-overlay-{{ section.id }}`);
      const designText = document.getElementById(`nt-design-text-{{ section.id }}`);
      
      if (overlayDiv && designText) {
        designText.style.display = 'none';
        
        // Remove any existing uploaded image
        const existingImg = overlayDiv.querySelector('img');
        if (existingImg) {
          existingImg.remove();
        }
        
        const uploadedImg = document.createElement('img');
        uploadedImg.src = imageData;
        uploadedImg.style.cssText = `
          width: 100% !important;
          height: 100% !important;
          object-fit: contain !important;
          display: block;
          pointer-events: none;
        `;
        
        overlayDiv.appendChild(uploadedImg);
        
        this.placementState.hasUploadedDesign = true;
        this.placementState.designSelected = true;
        
        console.log('‚úÖ Design applied to mockup');
        
        // Show canvas nudge controls
        const nudgeControls = document.getElementById('canvas-nudge-controls-{{ section.id }}');
        if (nudgeControls) {
          nudgeControls.style.opacity = '1';
          nudgeControls.style.pointerEvents = 'auto';
          console.log('‚úÖ Canvas nudge controls visible');
        }
        this.showMessage('üé® Design uploaded! Use canvas zoom controls and precise arrow keys for fine-tuning.', 'success');
      }
    },
    
    downloadComposite() {
      console.log('üì• Starting download composite...');
      console.log('Current placement state:', this.placementState);
      
      const canvas = document.createElement("canvas");
      const ctx = canvas.getContext("2d");
      
      // Use higher resolution for better quality
      canvas.width = 2000;
      canvas.height = 2000;
      
      const baseImg = new Image();
      baseImg.crossOrigin = "anonymous";
      baseImg.src = document.getElementById("nt-base-{{ section.id }}").src;
      
      baseImg.onload = () => {
        console.log('‚úÖ Base image loaded, drawing to canvas');
        ctx.drawImage(baseImg, 0, 0, canvas.width, canvas.height);

        const overlayImg = document.querySelector(`#nt-overlay-{{ section.id }} img`);
        console.log('Overlay image found:', overlayImg);
            
        if (overlayImg && overlayImg.src && this.placementState.hasUploadedDesign) {
          console.log('üé® Processing uploaded design for download');
          const designImg = new Image();
          designImg.crossOrigin = "anonymous";
          designImg.src = overlayImg.src;
          
          designImg.onload = () => {
            console.log('‚úÖ Design image loaded, applying to canvas');
            
            // Use the current placement state values
            const topPct = this.placementState.topPct / 100;
            const leftPct = this.placementState.leftPct / 100;
            const widthPct = this.placementState.widthPct / 100;
            const heightPct = this.placementState.heightPct / 100;
            const rotateDeg = this.placementState.rotateDeg || 0;

            // Calculate design position and size on canvas
            const designX = canvas.width * leftPct - (canvas.width * widthPct) / 2; // Center horizontally
            const designY = canvas.height * topPct;
            const designWidth = canvas.width * widthPct;
            const designHeight = canvas.height * heightPct;
            
            console.log('Design positioning:', {
              x: designX,
              y: designY,
              width: designWidth,
              height: designHeight,
              rotation: rotateDeg
            });
            
            // Apply rotation and draw the design
            ctx.save();
            ctx.translate(designX + designWidth / 2, designY + designHeight / 2);
            ctx.rotate(rotateDeg * Math.PI / 180);
            ctx.drawImage(designImg, -designWidth / 2, -designHeight / 2, designWidth, designHeight);
            ctx.restore();

            console.log('‚úÖ Design applied to canvas, starting download');
            const a = document.createElement('a');
            a.download = `custom_mockup_${this.state.view}_${this.state.color}.png`;
            a.href = canvas.toDataURL("image/png");
            a.click();
            
            this.showMessage('üì• Mockup downloaded with design!', 'success');
          };

          designImg.onerror = () => {
            console.error('‚ùå Failed to load design image for download');
            this.showMessage('‚ùå Failed to load design for download', 'error');
          };
        } else {
          console.log('‚ÑπÔ∏è No uploaded design found, downloading base mockup only');
          const a = document.createElement('a');
          a.download = `custom_mockup_${this.state.view}_${this.state.color}.png`;
          a.href = canvas.toDataURL("image/png");
          a.click();
          
          this.showMessage('üì• Mockup downloaded (no design)', 'info');
        }
      };
      
      baseImg.onerror = () => {
        console.error('‚ùå Failed to load base image for download');
        this.showMessage('‚ùå Failed to load base image for download', 'error');
      };
    },

    downloadMockup() {
      this.downloadComposite();
    },

    bindPlacementGuide() {
      const toggleBtn = document.getElementById(`nt-toggle-guide-{{ section.id }}`);
      const guideText = document.getElementById(`nt-guide-text-{{ section.id }}`);
      const overlay = document.getElementById(`nt-overlay-{{ section.id }}`);
      let guideVisible = false;
      
      if (toggleBtn && overlay) {
        toggleBtn.addEventListener('click', () => {
          guideVisible = !guideVisible;
          
          if (guideVisible) {
            // Show guide - add red border and crosshairs
            overlay.style.border = '2px dashed #ef4444';
            overlay.style.boxShadow = '0 0 0 2px rgba(239, 68, 68, 0.2), inset 0 0 0 2px rgba(239, 68, 68, 0.1)';
            
            // Add crosshairs using pseudo-elements via a style element
            if (!document.getElementById('placement-guide-style-{{ section.id }}')) {
              const styleEl = document.createElement('style');
              styleEl.id = 'placement-guide-style-{{ section.id }}';
              styleEl.textContent = `
                #nt-overlay-{{ section.id }}::before,
                #nt-overlay-{{ section.id }}::after {
                  content: '';
                  position: absolute;
                  background: rgba(239, 68, 68, 0.5);
                  z-index: 1000;
                  pointer-events: none;
                }
                #nt-overlay-{{ section.id }}::before {
                  top: 50%;
                  left: 0;
                  right: 0;
                  height: 2px;
                  transform: translateY(-50%);
                }
                #nt-overlay-{{ section.id }}::after {
                  left: 50%;
                  top: 0;
                  bottom: 0;
                  width: 2px;
                  transform: translateX(-50%);
                }
              `;
              document.head.appendChild(styleEl);
            }
            
            if (guideText) guideText.textContent = 'Hide';
            this.showMessage('üìê Placement guide enabled - red border shows print area', 'success');
          } else {
            // Hide guide - remove border and crosshairs
            overlay.style.border = '2px dashed rgba(39, 225, 193, 0.3)';
            overlay.style.boxShadow = 'inset 0 4px 12px rgba(0, 0, 0, 0.1)';
            
            // Remove crosshairs style
            const styleEl = document.getElementById('placement-guide-style-{{ section.id }}');
            if (styleEl) {
              styleEl.remove();
            }
            
            if (guideText) guideText.textContent = 'Show';
            this.showMessage('üìê Placement guide disabled', 'success');
          }
        });
      }
    },
    
    removeDesign() {
      const overlay = document.getElementById('nt-overlay-{{ section.id }}');
      if (overlay) {
        overlay.innerHTML = '';
        this.placementState.hasUploadedDesign = false;
        this.placementState.designSelected = false;
        console.log('üóëÔ∏è Design removed');
        this.showMessage('üóëÔ∏è Design removed', 'info');
      }
    },
    
    applyPerfectFit() {
      // Optimal dimensions for perfect fit in print area
      // These values are based on the console debug output for optimal positioning
      const perfectDimensions = {
        topPct: 29.142857142856876,     // Exact optimal top position
        leftPct: 49.96,                 // Adjusted left position (50.21 - 0.25 nudge step)
        widthPct: 37,                   // Optimal width for design proportions
        heightPct: 42,                  // Optimal height for design proportions
        rotateDeg: 0                    // No rotation for perfect fit
      };

      // Update placement state
      this.placementState.topPct = perfectDimensions.topPct;
      this.placementState.leftPct = perfectDimensions.leftPct;
      this.placementState.widthPct = perfectDimensions.widthPct;
      this.placementState.heightPct = perfectDimensions.heightPct;
      this.placementState.rotateDeg = perfectDimensions.rotateDeg;

      // Update the display and position
      this.updatePlacementDisplay();
      this.updateDesignPosition();

      // Add animation effect
      const overlay = document.getElementById('nt-overlay-{{ section.id }}');
      if (overlay) {
        overlay.style.transition = 'transform 0.3s ease';
        overlay.style.transform = `translateX(-50%) rotate(${perfectDimensions.rotateDeg}deg) scale(1.05)`;
        setTimeout(() => {
          overlay.style.transform = `translateX(-50%) rotate(${perfectDimensions.rotateDeg}deg) scale(1)`;
        }, 200);
      }

      this.showMessage('‚ú® Perfect fit applied! Design positioned optimally in print area', 'success');
    },

    perfectFit() {
      if (!this.placementState.hasUploadedDesign) {
        alert('‚ö†Ô∏è Please upload a design first!');
        return;
      }
      this.applyPerfectFit();
    },
    
    submitRequest() {
      if (!this.placementState.hasUploadedDesign) {
        this.showMessage('‚ùå Please upload a design first', 'error');
        return;
      }
      
      // Show the customer information form
      const formSection = document.getElementById(`nt-submit-request-{{ section.id }}`);
      if (formSection) {
        formSection.style.display = 'block';
        formSection.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
      }
    },

    async submitTShirtRequest() {
      console.log('üöÄ === Starting submitTShirtRequest ===');
      console.log('üìã Checking prerequisites...');
      
      // Check if design is uploaded
      if (!this.placementState.hasUploadedDesign) {
        console.error('‚ùå No design uploaded');
        this.showMessage('‚ùå Please upload a design first', 'error');
        return;
      }
      console.log('‚úÖ Design is uploaded');
      
      // Check if Supabase client is available
      if (!window.supabaseClient) {
        console.error('‚ùå Supabase client not available');
        this.showMessage('‚ùå Database connection not available. Please refresh the page and try again.', 'error');
        return;
      }
      console.log('‚úÖ Supabase client is available');
      
      // Check if EmailJS is available
      if (typeof emailjs === 'undefined') {
        console.error('‚ùå EmailJS not loaded');
        this.showMessage('‚ùå Email service not available. Please refresh the page and try again.', 'error');
        return;
      }
      console.log('‚úÖ EmailJS is available');

      // Get form data
      const customerName = document.getElementById(`nt-customer-name-{{ section.id }}`).value.trim();
      const customerEmail = document.getElementById(`nt-customer-email-{{ section.id }}`).value.trim();
      const customerPhone = document.getElementById(`nt-customer-phone-{{ section.id }}`).value.trim();
      const tshirtSize = document.getElementById(`nt-tshirt-size-{{ section.id }}`).value;
      const customerMessage = document.getElementById(`nt-customer-message-{{ section.id }}`).value.trim();

      // Validate required fields
      if (!customerName || !customerEmail) {
        this.showMessage('‚ùå Please fill in all required fields', 'error');
        return;
      }

      // Validate email format
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      if (!emailRegex.test(customerEmail)) {
        this.showMessage('‚ùå Please enter a valid email address', 'error');
        return;
      }

      try {
        // Add loading state to button
        const submitBtn = document.getElementById(`nt-submit-request-form-btn-{{ section.id }}`);
        if (submitBtn) {
          submitBtn.classList.add('loading');
          submitBtn.style.pointerEvents = 'none';
          submitBtn.textContent = '‚è≥ Submitting...';
        }
        
        this.showMessage('üì§ Submitting your request...', 'info');
        
        // Generate mockup image for submission
        this.showMessage('üé® Generating design preview...', 'info');
        const mockupImageData = await this.generateMockupForSubmission();
        
        // Upload mockup to storage and get URL
        let mockupImageUrl = null;
        try {
          mockupImageUrl = await this.uploadMockupToStorage(mockupImageData);
        } catch (error) {
          console.warn('Could not upload mockup image:', error);
        }
        
        // Upload design to storage if available
        let designImageUrl = null;
        try {
          designImageUrl = await this.uploadDesignToStorage();
        } catch (error) {
          console.warn('Could not upload design image:', error);
        }
        
        // Prepare request data
        const requestData = {
          customer_name: customerName,
          customer_email: customerEmail,
          customer_phone: customerPhone || null,
          customer_message: customerMessage || null,
          tshirt_size: tshirtSize || null,
          design_data: {
            position: {
              top: this.placementState.topPct,
              left: this.placementState.leftPct,
              width: this.placementState.widthPct,
              height: this.placementState.heightPct,
              rotation: this.placementState.rotateDeg
            },
            view: this.state.view,
            color: this.state.color,
            canvas_size: { width: 2000, height: 2000 },
            has_uploaded_design: this.placementState.hasUploadedDesign
          },
          design_image_url: designImageUrl,
          mockup_image_url: mockupImageUrl
        };

        // Submit to Supabase database
        const supabaseResult = await this.submitToSupabase(requestData);
        
        if (supabaseResult.success) {
          const requestId = supabaseResult.requestId ? ` (Request #${supabaseResult.requestId.slice(-8)})` : '';
          
          // Send email with images to shopping@newthrifts.com
          console.log('üìß Sending email with images to shopping@newthrifts.com...');
          const emailResult = await this.sendEmailWithImages(requestData);
          
          if (emailResult.success) {
            this.showMessage(`üéâ Request submitted successfully! Email sent to our team. We'll contact you within 24 hours.${requestId}`, 'success');
            console.log('‚úÖ Email with images sent to shopping@newthrifts.com');
          } else {
            this.showMessage(`üéâ Request submitted successfully! However, email notification failed. We'll still process your request.${requestId}`, 'warning');
            console.warn('‚ö†Ô∏è Email sending failed:', emailResult.error);
          }
          
          console.log('‚úÖ Custom t-shirt request submitted:', {
            requestId: supabaseResult.requestId,
            customerEmail: customerEmail,
            hasDesign: this.placementState.hasUploadedDesign,
            emailSent: emailResult.success
          });
        } else {
          throw new Error(supabaseResult.error || 'Failed to save request to database');
        }
        
        // Hide form and reset
        document.getElementById(`nt-submit-request-{{ section.id }}`).style.display = 'none';
        this.resetRequestForm();
        
        // Remove loading state
        if (submitBtn) {
          submitBtn.classList.remove('loading');
          submitBtn.style.pointerEvents = 'auto';
          submitBtn.textContent = 'üöÄ Submit Request';
        }

      } catch (error) {
        console.error('Error submitting request:', error);
        this.showMessage('‚ùå Failed to submit request. Please try again.', 'error');
        
        // Remove loading state on error
        const submitBtn = document.getElementById(`nt-submit-request-form-btn-{{ section.id }}`);
        if (submitBtn) {
          submitBtn.classList.remove('loading');
          submitBtn.style.pointerEvents = 'auto';
          submitBtn.textContent = 'üöÄ Submit Request';
        }
      }
    },

    resetRequestForm() {
      document.getElementById(`nt-customer-name-{{ section.id }}`).value = '';
      document.getElementById(`nt-customer-email-{{ section.id }}`).value = '';
      document.getElementById(`nt-customer-phone-{{ section.id }}`).value = '';
      document.getElementById(`nt-tshirt-size-{{ section.id }}`).value = '';
      document.getElementById(`nt-customer-message-{{ section.id }}`).value = '';
    },

    async submitToSupabase(requestData) {
      try {
        console.log('üîç Debugging submitToSupabase...');
        console.log('Request data:', requestData);
        
        // Check if Supabase is available
        if (typeof window.NewThriftsCustomRequests === 'undefined') {
          console.warn('‚ùå Supabase custom requests API not loaded');
          console.log('Available window objects:', Object.keys(window).filter(k => k.includes('supabase') || k.includes('NewThrifts')));
          return { success: false, error: 'Database service not available' };
        }

        console.log('‚úÖ NewThriftsCustomRequests API found');
        
        // Try the existing Supabase API first
        console.log('üì§ Calling submitCustomRequest...');
        const result = await window.NewThriftsCustomRequests.submitCustomRequest(requestData);
        
        console.log('üì• Result from submitCustomRequest:', result);
        
        if (result.success) {
          console.log('‚úÖ Request saved to Supabase:', result.requestId);
          return { success: true, requestId: result.requestId };
        } else {
          console.error('‚ùå Supabase submission failed:', result.error);
          
          // Try direct Supabase connection as fallback
          console.log('üîÑ Trying direct Supabase connection...');
          return await this.submitWithGlobalClient(requestData);
        }
        
      } catch (error) {
        console.error('‚ùå Error in submitToSupabase:', error);
        console.error('Error stack:', error.stack);
        return { success: false, error: error.message || 'Submission failed' };
      }
    },

    async submitWithGlobalClient(requestData) {
      try {
        console.log('üîß Using global Supabase client for submission...');
        
        const client = window.supabaseClient;
        
        if (!client) {
          console.error('‚ùå Global Supabase client not available');
          return { success: false, error: 'Global client not available' };
        }

        console.log('‚úÖ Global Supabase client found, submitting data...');

        // Insert request into database (simplified)
        const insertData = {
          customer_email: requestData.customer_email,
          customer_name: requestData.customer_name,
          status: 'pending'
        };
        
        // Add optional fields only if they exist
        if (requestData.customer_phone) insertData.customer_phone = requestData.customer_phone;
        if (requestData.customer_message) insertData.customer_message = requestData.customer_message;
        if (requestData.design_image_url) insertData.design_image_url = requestData.design_image_url;
        if (requestData.mockup_image_url) insertData.mockup_image_url = requestData.mockup_image_url;
        if (requestData.design_data) insertData.design_data = requestData.design_data;
        if (requestData.tshirt_size) insertData.tshirt_size = requestData.tshirt_size;
        
        console.log('üì§ Inserting data:', insertData);
        
        const { data, error } = await client
          .from('custom_tshirt_requests')
          .insert([insertData])
          .select()
          .single();

        if (error) {
          console.error('‚ùå Global client Supabase error:', error);
          return { success: false, error: error.message };
        }

        console.log('‚úÖ Global client submission successful:', data);
        return { success: true, requestId: data.id };

      } catch (error) {
        console.error('‚ùå Error in global client submission:', error);
        return { success: false, error: error.message || 'Global client submission failed' };
      }
    },

    async sendEmailWithImages(requestData) {
      try {
        console.log('üìß Preparing to send email with images to shopping@newthrifts.com...');
        
        // Images are now uploaded to Supabase storage with public URLs
        const emailContent = this.createEmailContent(requestData);
        
        console.log('‚úÖ Image URLs generated:');
        console.log('Design URL:', requestData.design_image_url ? '‚úÖ Uploaded' : '‚ùå Failed');
        console.log('Mockup URL:', requestData.mockup_image_url ? '‚úÖ Uploaded' : '‚ùå Failed');
        
        // Send email via EmailJS
        console.log('üéØ Sending email via EmailJS...');
        const emailResult = await this.sendViaEmailJS(requestData, emailContent);
        
        console.log('üìä EmailJS result:', emailResult);
        
        if (emailResult.success) {
          console.log('‚úÖ EmailJS email with images sent successfully to shopping@newthrifts.com');
          return { success: true, message: 'Email sent with images attached via EmailJS' };
        } else {
          console.error('‚ùå EmailJS email failed:', emailResult.error);
          return { success: false, error: 'Failed to send email via EmailJS: ' + emailResult.error };
        }
        
      } catch (error) {
        console.error('‚ùå Error sending email with images:', error);
        return { success: false, error: error.message };
      }
    },

    createEmailContent(requestData) {
      return {
        to: 'shopping@newthrifts.com',
        subject: `üé® Custom T-Shirt Request from ${requestData.customer_name}`,
        body: `Email content will be handled by EmailJS template`
      };
    },

    async sendViaEmailJS(requestData, emailContent) {
      try {
        console.log('üìß Attempting EmailJS email with images...');
        
        // Check if EmailJS is available
        if (typeof emailjs === 'undefined') {
          throw new Error('EmailJS not loaded. Please include EmailJS script.');
        }
        
        // Helper function to safely convert values to strings
        const s = v => (v == null || v === "") ? "‚Äî" : String(v);
        
        // Ensure URLs are absolute HTTPS links
        const ensureAbsoluteUrl = (url) => {
          if (!url || url === '#') return '‚Äî';
          if (url.startsWith('http://') || url.startsWith('https://')) return url;
          // If relative URL, make it absolute (shouldn't happen, but just in case)
          return url.startsWith('/') ? `https://newthrifts.com${url}` : url;
        };
        
        // Create email template parameters with proper formatting
        const templateParams = {
          name: s(requestData.customer_name),
          email: s(requestData.customer_email),
          phone: s(requestData.customer_phone),
          tshirt_size: s(requestData.tshirt_size),
          message: s(requestData.customer_message),
          design_position: s(`Top ${requestData.design_data.position.top.toFixed(2)}%, Left ${requestData.design_data.position.left.toFixed(2)}%`),
          design_size: s(`${requestData.design_data.position.width.toFixed(0)}% √ó ${requestData.design_data.position.height.toFixed(0)}%`),
          design_rotation: s(`${requestData.design_data.position.rotation}¬∞`),
          design_view: s(requestData.design_data.view),
          tshirt_color: s(requestData.design_data.color),
          submission_date: s(new Date().toLocaleString()),
          request_id: s(requestData.id || 'Pending'),
          design_url: ensureAbsoluteUrl(requestData.design_image_url),
          mockup_url: ensureAbsoluteUrl(requestData.mockup_image_url),
          logo_url: s('https://cdn.shopify.com/s/files/1/0644/9525/5650/files/NewThriftsLogo.svg?v=1760718145')
        };
        
        // Send email via EmailJS
        const result = await emailjs.send(
          'service_f4r34d3', // EmailJS service ID
          'template_qiquke8', // EmailJS template ID
          templateParams
        );
        
        console.log('‚úÖ EmailJS email sent successfully:', result);
        console.debug('[email params]', templateParams);
        return { success: true, method: 'EmailJS', messageId: result.text };
        
      } catch (error) {
        console.warn('‚ö†Ô∏è EmailJS email failed:', error);
        return { success: false, error: error.message, method: 'EmailJS' };
      }
    },

    async generateMockupForSubmission() {
      return new Promise((resolve) => {
        const canvas = document.createElement("canvas");
        const ctx = canvas.getContext("2d");
        
        canvas.width = 2000;
        canvas.height = 2000;
        
        const baseImg = new Image();
        baseImg.crossOrigin = "anonymous";
        baseImg.src = document.getElementById("nt-base-{{ section.id }}").src;
        
        baseImg.onload = () => {
          ctx.drawImage(baseImg, 0, 0, canvas.width, canvas.height);

          const overlayImg = document.querySelector(`#nt-overlay-{{ section.id }} img`);
          
          if (overlayImg && overlayImg.src) {
            const designImg = new Image();
            designImg.crossOrigin = "anonymous";
            designImg.src = overlayImg.src;
            
            designImg.onload = () => {
              const topPct = this.placementState.topPct / 100;
              const leftPct = this.placementState.leftPct / 100;
              const widthPct = this.placementState.widthPct / 100;
              const heightPct = this.placementState.heightPct / 100;
              const rotateDeg = this.placementState.rotateDeg || 0;

              const designX = canvas.width * leftPct - (canvas.width * widthPct) / 2;
              const designY = canvas.height * topPct;
              const designWidth = canvas.width * widthPct;
              const designHeight = canvas.height * heightPct;
              
              ctx.save();
              ctx.translate(designX + designWidth / 2, designY + designHeight / 2);
              ctx.rotate(rotateDeg * Math.PI / 180);
              ctx.drawImage(designImg, -designWidth / 2, -designHeight / 2, designWidth, designHeight);
              ctx.restore();

              resolve(canvas.toDataURL("image/png"));
            };
          } else {
            resolve(canvas.toDataURL("image/png"));
          }
        };
      });
    },

    async uploadMockupToStorage(base64Data) {
      if (!base64Data) return null;
      
      try {
        const response = await fetch(base64Data);
        const blob = await response.blob();
        
        const timestamp = Date.now();
        const filename = `mockup_${timestamp}.png`;
        
        const client = window.supabaseClient;
        if (!client) {
          throw new Error('Supabase client not available');
        }
        
        const { data, error } = await client
          .storage
          .from('mockup-previews')
          .upload(filename, blob, {
            contentType: 'image/png',
            upsert: false
          });
          
        if (error) throw error;
        
        const { data: urlData } = client
          .storage
          .from('mockup-previews')
          .getPublicUrl(filename);
          
        return urlData.publicUrl;
      } catch (error) {
        console.error('Mockup upload error:', error);
        return null;
      }
    },

    async uploadDesignToStorage() {
      console.log('üé® Starting design upload to storage...');
      const overlayImg = document.querySelector(`#nt-overlay-{{ section.id }} img`);
      
      if (!overlayImg) {
        console.warn('‚ö†Ô∏è No overlay image element found');
        return null;
      }
      
      if (!overlayImg.src) {
        console.warn('‚ö†Ô∏è Overlay image has no src');
        return null;
      }
      
      console.log('‚úÖ Found overlay image');
      console.log('üìã Image src type:', overlayImg.src.substring(0, 30));
      
      try {
        // Check if it's an SVG by examining the data URL or src
        const isSVG = overlayImg.src.includes('data:image/svg+xml') || 
                      overlayImg.src.includes('.svg') ||
                      overlayImg.src.toLowerCase().includes('svg');
        
        console.log('üîç Is SVG?', isSVG);
        
        let uploadBlob;
        
        if (isSVG) {
          console.log('üîÑ Converting SVG to PNG using canvas...');
          
          // Create a canvas to convert SVG to PNG
          const canvas = document.createElement('canvas');
          const ctx = canvas.getContext('2d');
          
          // Set canvas size - use a high resolution for quality
          const targetWidth = 2000;
          const targetHeight = 2000;
          canvas.width = targetWidth;
          canvas.height = targetHeight;
          
          console.log(`üìê Canvas size: ${canvas.width}x${canvas.height}`);
          
          // Create a new image to draw on canvas
          const img = new Image();
          img.crossOrigin = 'anonymous';
          
          // Wait for image to load
          await new Promise((resolve, reject) => {
            img.onload = () => {
              console.log('‚úÖ SVG image loaded into temporary image element');
              // Draw with white background
              ctx.fillStyle = 'white';
              ctx.fillRect(0, 0, canvas.width, canvas.height);
              // Draw the SVG
              ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
              console.log('‚úÖ SVG drawn to canvas');
              resolve();
            };
            img.onerror = (err) => {
              console.error('‚ùå Failed to load SVG into image element:', err);
              reject(err);
            };
            img.src = overlayImg.src;
          });
          
          // Convert canvas to PNG blob
          uploadBlob = await new Promise((resolve) => {
            canvas.toBlob((blob) => {
              console.log('‚úÖ Canvas converted to PNG blob');
              resolve(blob);
            }, 'image/png', 1.0);
          });
          
          console.log('‚úÖ Final PNG blob - size:', uploadBlob.size, 'type:', uploadBlob.type);
        } else {
          // Not an SVG, just fetch and upload as-is
          console.log('üì• Not an SVG, fetching original image...');
          const response = await fetch(overlayImg.src);
          uploadBlob = await response.blob();
          console.log('‚úÖ Original blob - size:', uploadBlob.size, 'type:', uploadBlob.type);
        }
        
        const timestamp = Date.now();
        const filename = `design_${timestamp}.png`;
        console.log('üìù Uploading as:', filename);
        
        const client = window.supabaseClient;
        if (!client) {
          throw new Error('Supabase client not available');
        }
        
        const { data, error} = await client
          .storage
          .from('design-uploads')
          .upload(filename, uploadBlob, {
            contentType: 'image/png',
            upsert: false
          });
          
        if (error) {
          console.error('‚ùå Supabase upload error:', error);
          throw error;
        }
        
        console.log('‚úÖ Design uploaded to Supabase:', data);
        
        const { data: urlData } = client
          .storage
          .from('design-uploads')
          .getPublicUrl(filename);
        
        console.log('‚úÖ Public URL generated:', urlData.publicUrl);
        return urlData.publicUrl;
      } catch (error) {
        console.error('‚ùå Design upload error:', error);
        console.error('Error details:', error);
        return null;
      }
    },
    
    rotateDesign() {
      if (!this.placementState.hasUploadedDesign) {
        alert('‚ö†Ô∏è Please upload a design first!');
        return;
      }
      console.log('‚Ü∫ Rotating design...');
      this.showMessage('‚Ü∫ Design rotated', 'info');
    },
    
    zoomDesign() {
      if (!this.placementState.hasUploadedDesign) {
        alert('‚ö†Ô∏è Please upload a design first!');
        return;
      }
      console.log('üîç Zooming design...');
      this.showMessage('üîç Design zoomed', 'info');
    },
    
    validateDesign() {
      if (!this.placementState.hasUploadedDesign) {
        alert('‚ö†Ô∏è Please upload a design first!');
        return;
      }
      alert('‚úÖ Design validation passed! Your design is ready for submission.');
    },
    
    resetDesign() {
      if (!this.placementState.hasUploadedDesign) {
        alert('‚ö†Ô∏è No design to reset!');
        return;
      }
      console.log('üîÑ Resetting design...');
      this.showMessage('üîÑ Design reset', 'info');
    },
    
    showMessage(text, type = 'info') {
      const existingMessage = document.querySelector('.nt-message');
      if (existingMessage) {
        existingMessage.remove();
      }
      
      const message = document.createElement('div');
      message.className = 'nt-message';
      const colors = {
        success: 'linear-gradient(45deg, #10b981, #059669)',
        error: 'linear-gradient(45deg, #ef4444, #dc2626)',
        info: 'linear-gradient(45deg, #3b82f6, #1d4ed8)'
      };
      
      message.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: ${colors[type] || colors.info};
        color: white;
        padding: 15px 25px;
        border-radius: 8px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        z-index: 10000;
        font-weight: 600;
        animation: slideIn 0.3s ease;
      `;
      message.textContent = text;
      document.body.appendChild(message);
      
      setTimeout(() => {
        message.style.animation = 'slideOut 0.3s ease';
        setTimeout(() => message.remove(), 300);
      }, 3000);
    }
  };
  
  // Initialize the mockup and make placementState globally accessible for Edit modal
  mockup.init();
  window.placementState = mockup.placementState;
  
  console.log('üöÄ Custom Studio Mockup initialized! üé®');
}

// Add the testPerfectFit function for debugging
(function() {
  console.log('üéØ Registering testPerfectFit function...');
  
  window.testPerfectFit = function() {
    console.log('üéØ Testing Perfect Fit with exact dimensions...');
    
    // Find the mockup section
    const section = document.getElementById('nt-mockup-{{ section.id }}');
    if (!section) {
      console.error('‚ùå Mockup section not found!');
      return;
    }
    
    // Get the overlay and canvas
    const overlay = document.getElementById('nt-overlay-{{ section.id }}');
    const canvas = document.getElementById('nt-mockup-canvas-{{ section.id }}');
    
    if (!overlay || !canvas) {
      console.error('‚ùå Overlay or canvas not found!');
      return;
    }
    
    // Apply exact dimensions
    const perfectDimensions = {
      topPct: 29.142857142856876,
      leftPct: 50.21428571428568,
      widthPct: 37,
      heightPct: 42,
      rotateDeg: 0
    };
    
    // Update CSS variables
    canvas.style.setProperty('--overlay-top', perfectDimensions.topPct + '%');
    canvas.style.setProperty('--overlay-left', perfectDimensions.leftPct + '%');
    canvas.style.setProperty('--overlay-width', perfectDimensions.widthPct + '%');
    canvas.style.setProperty('--overlay-height', perfectDimensions.heightPct + '%');
    canvas.style.setProperty('--overlay-rotate', perfectDimensions.rotateDeg + 'deg');
    
    // Update overlay directly
    overlay.style.top = perfectDimensions.topPct + '%';
    overlay.style.left = perfectDimensions.leftPct + '%';
    overlay.style.width = perfectDimensions.widthPct + '%';
    overlay.style.height = perfectDimensions.heightPct + '%';
    overlay.style.transform = `translateX(-50%) rotate(${perfectDimensions.rotateDeg}deg)`;
    
    console.log('‚úÖ Perfect Fit applied with exact dimensions:');
    console.log(`Top: ${perfectDimensions.topPct}%`);
    console.log(`Left: ${perfectDimensions.leftPct}%`);
    console.log(`Width: ${perfectDimensions.widthPct}%`);
    console.log(`Height: ${perfectDimensions.heightPct}%`);
    console.log(`Rotation: ${perfectDimensions.rotateDeg}¬∞`);
    
    // Add animation
    overlay.style.transition = 'transform 0.3s ease';
    overlay.style.transform = `translateX(-50%) rotate(${perfectDimensions.rotateDeg}deg) scale(1.05)`;
    setTimeout(() => {
      overlay.style.transform = `translateX(-50%) rotate(${perfectDimensions.rotateDeg}deg) scale(1)`;
    }, 200);
    
    // Show success message on page
    const existingMessage = document.querySelector('.nt-message');
    if (existingMessage) {
      existingMessage.remove();
    }
    
    const message = document.createElement('div');
    message.className = 'nt-message';
    message.style.cssText = `
      position: fixed;
      top: 20px;
      right: 20px;
      background: linear-gradient(45deg, #10b981, #059669);
      color: white;
      padding: 15px 25px;
      border-radius: 8px;
      box-shadow: 0 4px 15px rgba(16, 185, 129, 0.4);
      z-index: 10000;
      font-weight: 600;
      animation: slideIn 0.3s ease;
    `;
    message.textContent = 'üéØ Perfect Fit test applied with exact dimensions!';
    document.body.appendChild(message);
    
    setTimeout(() => {
      message.style.animation = 'slideOut 0.3s ease';
      setTimeout(() => message.remove(), 300);
    }, 3000);
  };
  
  console.log('‚úÖ testPerfectFit is now available! Type: testPerfectFit()');
})();

// Size Chart Toggle Functionality - Initialize when studio opens
function initializeSizeChart() {
  console.log('üìè Initializing Size Chart...');
  const sizeChartToggle = document.getElementById('size-chart-toggle-{{ section.id }}');
  const sizeChartContent = document.getElementById('size-chart-content-{{ section.id }}');
  const sizeChartIcon = document.getElementById('size-chart-icon-{{ section.id }}');
  
  if (sizeChartToggle && sizeChartContent && sizeChartIcon) {
    console.log('‚úÖ Size Chart elements found, binding events...');
    sizeChartToggle.addEventListener('click', function() {
      if (sizeChartContent.style.display === 'none') {
        sizeChartContent.style.display = 'block';
        sizeChartIcon.style.transform = 'rotate(180deg)';
        // Use theme-appropriate open colors
        sizeChartToggle.style.background = 'linear-gradient(135deg, #059669, #047857)';
        console.log('üìè Size Chart opened');
      } else {
        sizeChartContent.style.display = 'none';
        sizeChartIcon.style.transform = 'rotate(0deg)';
        // Reset to default - CSS will handle theme colors
        sizeChartToggle.style.background = '';
        console.log('üìè Size Chart closed');
      }
    });
    console.log('‚úÖ Size Chart toggle functionality initialized');
  } else {
    console.error('‚ùå Size Chart elements not found:', {
      toggle: !!sizeChartToggle,
      content: !!sizeChartContent,
      icon: !!sizeChartIcon
    });
  }
}

// ========================================
// LOAD STUDIO EDIT OPERATIONS
// ========================================
const studioEditScript = document.createElement('script');
studioEditScript.src = '{{ "studio-edit.js" | asset_url }}';
studioEditScript.onload = function() {
  console.log('‚úÖ Studio Edit Operations loaded');
  initEditModal();
  initCanvasNudgeControls();
};
document.head.appendChild(studioEditScript);

// ========================================
// CANVAS NUDGE CONTROLS
// ========================================
function initCanvasNudgeControls() {
  const nudgeButtons = document.querySelectorAll('.canvas-nudge-btn');
  
  // Helper function to log current position after nudge
  function logDesignPosition(action) {
    setTimeout(() => {
      const overlay = document.querySelector('[id*="nt-overlay"]');
      const canvasContainer = document.querySelector('[id*="nt-mockup-canvas"]');
      
      if (overlay && canvasContainer) {
        const computed = window.getComputedStyle(canvasContainer);
        const overlayStyle = window.getComputedStyle(overlay);
        
        // Get CSS variables
        const cssVars = {
          '--overlay-top': computed.getPropertyValue('--overlay-top'),
          '--overlay-left': computed.getPropertyValue('--overlay-left'),
          '--overlay-width': computed.getPropertyValue('--overlay-width'),
          '--overlay-height': computed.getPropertyValue('--overlay-height'),
          '--overlay-rotate': computed.getPropertyValue('--overlay-rotate')
        };
        
        // Get computed position
        const rect = overlay.getBoundingClientRect();
        const canvasRect = canvasContainer.getBoundingClientRect();
        
        console.log(`üìç ${action}`);
        console.log({
          cssVariables: cssVars,
          computedPosition: {
            top: overlayStyle.top,
            left: overlayStyle.left,
            transform: overlayStyle.transform
          },
          dimensions: {
            width: overlay.offsetWidth + 'px',
            height: overlay.offsetHeight + 'px'
          },
          percentageOfCanvas: {
            top: (((rect.top - canvasRect.top) / canvasRect.height) * 100).toFixed(2) + '%',
            left: (((rect.left - canvasRect.left) / canvasRect.width) * 100).toFixed(2) + '%',
            width: ((overlay.offsetWidth / canvasContainer.offsetWidth) * 100).toFixed(2) + '%',
            height: ((overlay.offsetHeight / canvasContainer.offsetHeight) * 100).toFixed(2) + '%'
          }
        });
      }
    }, 50); // Small delay to ensure DOM has updated
  }
  
  // Wire up button clicks
  nudgeButtons.forEach(btn => {
    btn.addEventListener('click', (e) => {
      e.preventDefault();
      e.stopPropagation();
      
      const direction = btn.getAttribute('data-direction');
      let dx = 0, dy = 0;
      
      switch(direction) {
        case 'up': dy = -1; break;
        case 'down': dy = 1; break;
        case 'left': dx = -1; break;
        case 'right': dx = 1; break;
      }
      
      if (studio.editOps) {
        studio.editOps.nudge(dx, dy, 0.25); // Use step of 0.25 for ultra-fine control
        logDesignPosition(`üéÆ Nudged ${direction}`);
      }
    });
  });
  
  // Add keyboard arrow key support (global)
  document.addEventListener('keydown', (e) => {
    // Only respond if a design is uploaded and no input is focused
    if (!window.placementState?.hasUploadedDesign) return;
    if (document.activeElement.tagName === 'INPUT' || 
        document.activeElement.tagName === 'TEXTAREA') return;
    
    let dx = 0, dy = 0;
    let direction = '';
    
    switch(e.key) {
      case 'ArrowUp': dy = -1; direction = 'up'; e.preventDefault(); break;
      case 'ArrowDown': dy = 1; direction = 'down'; e.preventDefault(); break;
      case 'ArrowLeft': dx = -1; direction = 'left'; e.preventDefault(); break;
      case 'ArrowRight': dx = 1; direction = 'right'; e.preventDefault(); break;
      default: return; // Exit if not an arrow key
    }
    
    if (studio.editOps && (dx !== 0 || dy !== 0)) {
      studio.editOps.nudge(dx, dy, 0.25);
      logDesignPosition(`‚å®Ô∏è Keyboard nudge: ${direction}`);
    }
  });
  
  console.log('‚úÖ Canvas nudge controls initialized');
}

// ========================================
// DEBUG UTILITIES
// ========================================
window.debugImageSizes = function() {
  console.log('üîç DEBUG: Image Sizes (DETAILED)');
  console.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');
  
  // Find all images in the canvas
  const canvasContainer = document.querySelector('[id*="nt-mockup-canvas"]');
  const overlay = document.querySelector('[id*="nt-overlay"]');
  
  // Canvas Container Details
  if (canvasContainer) {
    const canvasStyle = window.getComputedStyle(canvasContainer);
    const canvasRect = canvasContainer.getBoundingClientRect();
    
    console.log('üì¶ Canvas Container (Detailed):', {
      dimensions: {
        offsetWidth: canvasContainer.offsetWidth,
        offsetHeight: canvasContainer.offsetHeight,
        clientWidth: canvasContainer.clientWidth,
        clientHeight: canvasContainer.clientHeight,
        scrollWidth: canvasContainer.scrollWidth,
        scrollHeight: canvasContainer.scrollHeight
      },
      boundingRect: {
        width: canvasRect.width,
        height: canvasRect.height,
        top: canvasRect.top,
        left: canvasRect.left,
        right: canvasRect.right,
        bottom: canvasRect.bottom
      },
      computedStyle: {
        width: canvasStyle.width,
        height: canvasStyle.height,
        padding: canvasStyle.padding,
        margin: canvasStyle.margin,
        border: canvasStyle.border,
        boxSizing: canvasStyle.boxSizing,
        aspectRatio: canvasStyle.aspectRatio,
        position: canvasStyle.position
      },
      aspectRatio: (canvasContainer.offsetWidth / canvasContainer.offsetHeight).toFixed(3)
    });
  }
  
  // Design Image Details
  if (overlay) {
    const overlayImg = overlay.querySelector('img');
    if (overlayImg) {
      const imgStyle = window.getComputedStyle(overlayImg);
      const imgRect = overlayImg.getBoundingClientRect();
      const canvasWidth = canvasContainer ? canvasContainer.offsetWidth : 0;
      const canvasHeight = canvasContainer ? canvasContainer.offsetHeight : 0;
      
      // Calculate percentages
      const widthPct = (overlayImg.offsetWidth / canvasWidth) * 100;
      const heightPct = (overlayImg.offsetHeight / canvasHeight) * 100;
      
      // Calculate scaling
      const scaleX = overlayImg.offsetWidth / overlayImg.naturalWidth;
      const scaleY = overlayImg.offsetHeight / overlayImg.naturalHeight;
      
      console.log('üé® Design Image (Detailed):', {
        naturalDimensions: {
          width: overlayImg.naturalWidth,
          height: overlayImg.naturalHeight,
          aspectRatio: (overlayImg.naturalWidth / overlayImg.naturalHeight).toFixed(3),
          totalPixels: (overlayImg.naturalWidth * overlayImg.naturalHeight).toLocaleString(),
          megapixels: ((overlayImg.naturalWidth * overlayImg.naturalHeight) / 1000000).toFixed(2) + 'MP'
        },
        displayDimensions: {
          width: overlayImg.offsetWidth,
          height: overlayImg.offsetHeight,
          clientWidth: overlayImg.clientWidth,
          clientHeight: overlayImg.clientHeight,
          aspectRatio: (overlayImg.offsetWidth / overlayImg.offsetHeight).toFixed(3)
        },
        boundingRect: {
          width: imgRect.width,
          height: imgRect.height,
          top: imgRect.top,
          left: imgRect.left
        },
        percentageOfCanvas: {
          width: widthPct.toFixed(2) + '%',
          height: heightPct.toFixed(2) + '%',
          area: ((widthPct * heightPct) / 100).toFixed(2) + '%'
        },
        scaling: {
          scaleX: scaleX.toFixed(4),
          scaleY: scaleY.toFixed(4),
          scaleFactor: ((scaleX + scaleY) / 2).toFixed(4),
          isScaledDown: scaleX < 1 || scaleY < 1,
          isScaledUp: scaleX > 1 || scaleY > 1,
          compressionRatio: (1 / scaleX).toFixed(2) + 'x'
        },
        computedStyle: {
          objectFit: imgStyle.objectFit,
          transform: imgStyle.transform,
          filter: imgStyle.filter,
          opacity: imgStyle.opacity
        },
        fileInfo: {
          src: overlayImg.src.substring(0, 80) + '...',
          complete: overlayImg.complete,
          currentSrc: overlayImg.currentSrc ? overlayImg.currentSrc.substring(0, 80) + '...' : 'N/A'
        }
      });
      
      // DPI Quality Analysis
      const printWidths = [6, 8, 10, 12]; // Common print sizes in inches
      console.log('üìê Quality Analysis (Multiple Print Sizes):');
      printWidths.forEach(printWidth => {
        const effectiveWidth = overlayImg.naturalWidth * (widthPct / 100);
        const dpi = Math.round(effectiveWidth / printWidth);
        const quality = dpi >= 300 ? '‚úÖ Excellent' : dpi >= 200 ? '‚úÖ Good' : dpi >= 150 ? '‚ö†Ô∏è OK' : dpi >= 100 ? '‚ö†Ô∏è Low' : '‚ùå Poor';
        console.log(`  ${printWidth}" print:`, {
          dpi: dpi,
          quality: quality,
          actualSize: `${(effectiveWidth / dpi).toFixed(2)}" x ${(overlayImg.naturalHeight * (heightPct / 100) / dpi).toFixed(2)}"`
        });
      });
      
      // Recommend optimal print size
      const optimalPrintWidth = (overlayImg.naturalWidth * (widthPct / 100)) / 300;
      console.log('üí° Recommendation:', {
        optimalPrintSize: `${optimalPrintWidth.toFixed(2)}" wide at 300 DPI`,
        currentDesignSize: `${widthPct.toFixed(2)}% of canvas (${overlayImg.offsetWidth}px)`,
        suggestion: optimalPrintWidth < 6 ? '‚ö†Ô∏è Consider higher resolution image' : '‚úÖ Resolution is good'
      });
      
    } else {
      console.log('‚ö†Ô∏è No design image found in overlay');
    }
  } else {
    console.log('‚ö†Ô∏è No overlay element found');
  }
  
  // Base T-shirt Image Details
  const baseImg = document.querySelector('[id*="nt-base"]');
  if (baseImg) {
    const baseStyle = window.getComputedStyle(baseImg);
    const baseRect = baseImg.getBoundingClientRect();
    
    console.log('üëï Base T-shirt Image (Detailed):', {
      naturalDimensions: {
        width: baseImg.naturalWidth,
        height: baseImg.naturalHeight,
        aspectRatio: (baseImg.naturalWidth / baseImg.naturalHeight).toFixed(3),
        totalPixels: (baseImg.naturalWidth * baseImg.naturalHeight).toLocaleString()
      },
      displayDimensions: {
        width: baseImg.offsetWidth,
        height: baseImg.offsetHeight,
        clientWidth: baseImg.clientWidth,
        clientHeight: baseImg.clientHeight
      },
      boundingRect: {
        width: baseRect.width,
        height: baseRect.height,
        top: baseRect.top,
        left: baseRect.left
      },
      scaling: {
        scaleX: (baseImg.offsetWidth / baseImg.naturalWidth).toFixed(4),
        scaleY: (baseImg.offsetHeight / baseImg.naturalHeight).toFixed(4)
      },
      computedStyle: {
        objectFit: baseStyle.objectFit,
        transform: baseStyle.transform,
        position: baseStyle.position
      },
      fileInfo: {
        filename: baseImg.src.substring(baseImg.src.lastIndexOf('/') + 1),
        complete: baseImg.complete
      }
    });
  }
  
  console.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');
};

window.debugCanvasSize = function() {
  console.log('üîç DEBUG: Canvas Dimensions (DETAILED)');
  console.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');
  
  const canvasContainer = document.querySelector('[id*="nt-mockup-canvas"]');
  
  if (canvasContainer) {
    const rect = canvasContainer.getBoundingClientRect();
    const computed = window.getComputedStyle(canvasContainer);
    const parent = canvasContainer.parentElement;
    
    console.log('üì¶ Canvas Container (Detailed):', {
      elementInfo: {
        id: canvasContainer.id,
        className: canvasContainer.className,
        tagName: canvasContainer.tagName
      },
      dimensions: {
        offsetWidth: canvasContainer.offsetWidth,
        offsetHeight: canvasContainer.offsetHeight,
        clientWidth: canvasContainer.clientWidth,
        clientHeight: canvasContainer.clientHeight,
        scrollWidth: canvasContainer.scrollWidth,
        scrollHeight: canvasContainer.scrollHeight,
        aspectRatio: (canvasContainer.offsetWidth / canvasContainer.offsetHeight).toFixed(3)
      },
      boundingRect: {
        width: rect.width,
        height: rect.height,
        top: rect.top,
        left: rect.left,
        right: rect.right,
        bottom: rect.bottom,
        x: rect.x,
        y: rect.y
      },
      computedStyle: {
        width: computed.width,
        height: computed.height,
        minWidth: computed.minWidth,
        minHeight: computed.minHeight,
        maxWidth: computed.maxWidth,
        maxHeight: computed.maxHeight,
        padding: computed.padding,
        paddingTop: computed.paddingTop,
        paddingRight: computed.paddingRight,
        paddingBottom: computed.paddingBottom,
        paddingLeft: computed.paddingLeft,
        margin: computed.margin,
        border: computed.border,
        borderRadius: computed.borderRadius,
        boxSizing: computed.boxSizing,
        aspectRatio: computed.aspectRatio,
        position: computed.position,
        display: computed.display,
        overflow: computed.overflow,
        transform: computed.transform,
        transformOrigin: computed.transformOrigin
      },
      background: {
        background: computed.background,
        backgroundColor: computed.backgroundColor,
        backgroundImage: computed.backgroundImage.substring(0, 100) + (computed.backgroundImage.length > 100 ? '...' : ''),
        backgroundSize: computed.backgroundSize,
        backgroundPosition: computed.backgroundPosition,
        backgroundRepeat: computed.backgroundRepeat
      },
      effects: {
        boxShadow: computed.boxShadow,
        filter: computed.filter,
        backdropFilter: computed.backdropFilter,
        opacity: computed.opacity,
        visibility: computed.visibility
      }
    });
    
    if (parent) {
      const parentRect = parent.getBoundingClientRect();
      console.log('üë®‚Äçüë¶ Parent Container:', {
        id: parent.id || 'No ID',
        className: parent.className,
        tagName: parent.tagName,
        dimensions: {
          offsetWidth: parent.offsetWidth,
          offsetHeight: parent.offsetHeight
        },
        boundingRect: {
          width: parentRect.width,
          height: parentRect.height
        },
        canvasPercentage: {
          width: ((canvasContainer.offsetWidth / parent.offsetWidth) * 100).toFixed(2) + '%',
          height: ((canvasContainer.offsetHeight / parent.offsetHeight) * 100).toFixed(2) + '%'
        }
      });
    }
    
    // Viewport information
    console.log('üñ•Ô∏è Viewport Info:', {
      windowSize: {
        innerWidth: window.innerWidth,
        innerHeight: window.innerHeight,
        outerWidth: window.outerWidth,
        outerHeight: window.outerHeight
      },
      canvasPercentageOfViewport: {
        width: ((canvasContainer.offsetWidth / window.innerWidth) * 100).toFixed(2) + '%',
        height: ((canvasContainer.offsetHeight / window.innerHeight) * 100).toFixed(2) + '%'
      },
      scrollPosition: {
        scrollX: window.scrollX,
        scrollY: window.scrollY,
        pageXOffset: window.pageXOffset,
        pageYOffset: window.pageYOffset
      },
      devicePixelRatio: window.devicePixelRatio
    });
    
    // CSS Variables (if any)
    const cssVars = [
      '--overlay-top',
      '--overlay-left',
      '--overlay-width',
      '--overlay-height',
      '--overlay-rotate'
    ];
    const extractedVars = {};
    cssVars.forEach(varName => {
      const value = computed.getPropertyValue(varName);
      if (value) extractedVars[varName] = value;
    });
    
    if (Object.keys(extractedVars).length > 0) {
      console.log('üé® CSS Variables:', extractedVars);
    }
    
    // Child elements count
    console.log('üìä Structure:', {
      childElementCount: canvasContainer.childElementCount,
      children: Array.from(canvasContainer.children).map(child => ({
        tagName: child.tagName,
        id: child.id || 'No ID',
        className: child.className
      }))
    });
    
  } else {
    console.log('‚ö†Ô∏è Canvas container not found');
  }
  
  console.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');
};

window.debugDesignPosition = function() {
  console.log('üîç DEBUG: Design Position');
  console.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');
  
  const overlay = document.querySelector('[id*="nt-overlay"]');
  
  if (overlay) {
    const computed = window.getComputedStyle(overlay);
    const rect = overlay.getBoundingClientRect();
    
    console.log('üé® Design Overlay:', {
      position: {
        top: computed.top,
        left: computed.left,
        transform: computed.transform
      },
      dimensions: {
        width: computed.width,
        height: computed.height,
        offsetWidth: overlay.offsetWidth,
        offsetHeight: overlay.offsetHeight
      },
      boundingRect: {
        top: rect.top,
        left: rect.left,
        width: rect.width,
        height: rect.height
      },
      zIndex: computed.zIndex,
      display: computed.display,
      visibility: computed.visibility
    });
    
    // Check if placementState exists
    if (window.placementState) {
      console.log('üìç Placement State:', window.placementState);
    }
  } else {
    console.log('‚ö†Ô∏è Overlay element not found');
  }
  
  console.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');
};

console.log('üõ†Ô∏è Debug utilities loaded. Available commands:');
console.log('  ‚Ä¢ debugImageSizes() - Check all image dimensions and quality');
console.log('  ‚Ä¢ debugCanvasSize() - Check canvas dimensions');
console.log('  ‚Ä¢ debugDesignPosition() - Check design overlay position');

// ========================================
// EDIT MODAL FUNCTIONALITY
// ========================================
function initEditModal() {
  const modal = document.getElementById('edit-modal-{{ section.id }}');
  const closeBtn = document.getElementById('edit-modal-close-{{ section.id }}');
  const doneBtn = document.getElementById('edit-done-btn-{{ section.id }}');
  
  // Tab switching
  const tabs = document.querySelectorAll('.edit-tab');
  const tabContents = document.querySelectorAll('.edit-tab-content');
  
  tabs.forEach(tab => {
    tab.addEventListener('click', () => {
      const tabName = tab.getAttribute('data-tab');
      
      // Update tab styles
      tabs.forEach(t => {
        t.style.background = 'transparent';
        t.style.color = '#64748b';
        t.classList.remove('active');
      });
      tab.style.background = '#27e1c1';
      tab.style.color = '#0f172a';
      tab.classList.add('active');
      
      // Show corresponding content
      tabContents.forEach(content => {
        content.style.display = 'none';
      });
      document.getElementById(`tab-${tabName}-{{ section.id }}`).style.display = 'block';
      
      // Update quality meter when switching to quality tab
      if (tabName === 'quality') {
        updateQualityMeter();
      }
    });
  });
  
  // Open modal
  function openEditModal() {
    // Check if design is uploaded using the placement state
    const hasDesign = window.placementState?.hasUploadedDesign || studio.currentDesignObj;
    
    if (!hasDesign) {
      alert('‚ö†Ô∏è Please upload a design first before editing.');
      return;
    }
    
    modal.style.display = 'block';
    studio.editOps?.open();
    updateQualityMeter();
    
    // Initialize transform values if using Fabric.js
    const obj = studio.currentDesignObj;
    if (obj) {
      document.getElementById('scale-input-{{ section.id }}').value = Math.round((obj.scaleX || 1) * 100);
      document.getElementById('rotation-input-{{ section.id }}').value = Math.round(obj.angle || 0);
    }
    
    // Populate the live preview with the canvas
    populatePreview();
  }
  
  // Function to populate/update the preview
  function populatePreview() {
    const previewContainer = document.getElementById('edit-preview-{{ section.id }}');
    if (!previewContainer) {
      console.warn('‚ö†Ô∏è Preview container not found');
      return;
    }
    
    console.log('üîç Looking for canvas/design to preview...');
    
    // Try multiple methods to find the canvas/design
    
    // Method 1: Find the main canvas container
    let canvasContainer = document.getElementById('nt-mockup-canvas-{{ section.id }}');
    
    // Method 2: Try finding by class
    if (!canvasContainer) {
      canvasContainer = document.querySelector('.nt-mockup__canvas');
      console.log('üì¶ Trying class selector:', !!canvasContainer);
    }
    
    // Method 3: Find any element with the canvas in its ID
    if (!canvasContainer) {
      canvasContainer = document.querySelector('[id*="mockup-canvas"]');
      console.log('üéØ Trying wildcard selector:', !!canvasContainer);
    }
    
    if (canvasContainer) {
      console.log('‚úÖ Found canvas container:', canvasContainer.id || canvasContainer.className);
      
      // Clone the entire canvas container
      const clonedCanvas = canvasContainer.cloneNode(true);
      
      // Remove any IDs to avoid conflicts
      clonedCanvas.id = 'preview-clone';
      clonedCanvas.querySelectorAll('[id]').forEach(el => el.id = '');
      
      // Force explicit display and dimensions
      clonedCanvas.style.cssText = `
        display: block !important;
        visibility: visible !important;
        opacity: 1 !important;
        position: relative !important;
        width: 350px !important;
        height: 350px !important;
        max-width: 100% !important;
        margin: 0 auto !important;
        transform: scale(0.9) !important;
        transform-origin: center !important;
        pointer-events: none !important;
        border-radius: 12px !important;
        overflow: visible !important;
      `;
      
      // Clear preview and add clone
      previewContainer.innerHTML = '';
      previewContainer.appendChild(clonedCanvas);
      
      // Log dimensions for debugging
      setTimeout(() => {
        const rect = clonedCanvas.getBoundingClientRect();
        console.log('üìê Clone dimensions:', rect.width, 'x', rect.height);
        console.log('üì¶ Clone in DOM:', document.getElementById('preview-clone') ? 'YES' : 'NO');
      }, 100);
      
      console.log('‚úÖ Preview populated with canvas');
      return;
    }
    
    // Fallback 1: Show just the uploaded image from overlay
    console.log('üîç Canvas not found, trying overlay image...');
    const overlayImg = document.querySelector('#nt-overlay-{{ section.id }} img');
    
    if (overlayImg) {
      console.log('‚úÖ Found overlay image');
      
      // Create a wrapper that mimics the t-shirt view
      const wrapper = document.createElement('div');
      wrapper.style.cssText = `
        position: relative;
        max-width: 400px;
        margin: 0 auto;
      `;
      
      // Clone the t-shirt base if available
      const tshirtBase = document.querySelector('#nt-base-{{ section.id }} img');
      if (tshirtBase) {
        const clonedBase = tshirtBase.cloneNode(true);
        clonedBase.style.cssText = `
          width: 100%;
          height: auto;
          display: block;
        `;
        wrapper.appendChild(clonedBase);
      }
      
      // Add the design overlay
      const clonedImg = overlayImg.cloneNode(true);
      clonedImg.style.cssText = `
        position: ${tshirtBase ? 'absolute' : 'relative'};
        top: ${tshirtBase ? '30%' : '0'};
        left: ${tshirtBase ? '50%' : '50%'};
        transform: translateX(-50%);
        max-width: ${tshirtBase ? '40%' : '80%'};
        max-height: 350px;
        object-fit: contain;
        pointer-events: none;
      `;
      wrapper.appendChild(clonedImg);
      
      previewContainer.innerHTML = '';
      previewContainer.appendChild(wrapper);
      console.log('‚úÖ Preview populated with design image + base');
      return;
    }
    
    // Fallback 2: Show message
    console.warn('‚ö†Ô∏è No canvas or image found');
    previewContainer.innerHTML = `
      <div style="text-align: center; padding: 40px;">
        <p style="color: #94a3b8; margin-bottom: 12px;">No design preview available</p>
        <p style="color: #cbd5e1; font-size: 13px;">Your changes will be applied to the main canvas</p>
      </div>
    `;
  }
  
  // Close modal
  function closeEditModal() {
    modal.style.display = 'none';
    studio.editOps?.close();
  }
  
  // Find Edit Design button - ID is nt-edit-{{ section.id }}
  const actualEditBtn = document.getElementById('nt-edit-{{ section.id }}');
  
  if (actualEditBtn) {
    actualEditBtn.addEventListener('click', openEditModal);
    console.log('‚úÖ Edit Design button (nt-edit-{{ section.id }}) wired to modal');
  } else {
    console.warn('‚ö†Ô∏è Could not find Edit Design button with ID: nt-edit-{{ section.id }}');
  }
  
  closeBtn.addEventListener('click', closeEditModal);
  doneBtn.addEventListener('click', closeEditModal);
  
  // Close on backdrop click
  modal.addEventListener('click', (e) => {
    if (e.target === modal) closeEditModal();
  });
  
  // ========================================
  // TRANSFORM TAB
  // ========================================
  document.getElementById('scale-input-{{ section.id }}').addEventListener('input', (e) => {
    studio.editOps?.scale(parseFloat(e.target.value));
    setTimeout(populatePreview, 100); // Update preview after transform
  });
  
  document.getElementById('rotation-input-{{ section.id }}').addEventListener('input', (e) => {
    studio.editOps?.rotate(parseFloat(e.target.value));
    setTimeout(populatePreview, 100); // Update preview after transform
  });
  
  document.getElementById('flip-h-btn-{{ section.id }}').addEventListener('click', () => {
    studio.editOps?.flipX();
    setTimeout(populatePreview, 100); // Update preview after transform
  });
  
  document.getElementById('flip-v-btn-{{ section.id }}').addEventListener('click', () => {
    studio.editOps?.flipY();
    setTimeout(populatePreview, 100); // Update preview after transform
  });
  
  // Nudge controls
  document.getElementById('nudge-up-{{ section.id }}').addEventListener('click', () => {
    studio.editOps?.nudge(0, -1);
    setTimeout(populatePreview, 100);
  });
  document.getElementById('nudge-down-{{ section.id }}').addEventListener('click', () => {
    studio.editOps?.nudge(0, 1);
    setTimeout(populatePreview, 100);
  });
  document.getElementById('nudge-left-{{ section.id }}').addEventListener('click', () => {
    studio.editOps?.nudge(-1, 0);
    setTimeout(populatePreview, 100);
  });
  document.getElementById('nudge-right-{{ section.id }}').addEventListener('click', () => {
    studio.editOps?.nudge(1, 0);
    setTimeout(populatePreview, 100);
  });
  
  // Arrow key support
  document.addEventListener('keydown', (e) => {
    if (modal.style.display === 'block') {
      if (e.key === 'ArrowUp') { e.preventDefault(); studio.editOps?.nudge(0, -1); setTimeout(populatePreview, 100); }
      if (e.key === 'ArrowDown') { e.preventDefault(); studio.editOps?.nudge(0, 1); setTimeout(populatePreview, 100); }
      if (e.key === 'ArrowLeft') { e.preventDefault(); studio.editOps?.nudge(-1, 0); setTimeout(populatePreview, 100); }
      if (e.key === 'ArrowRight') { e.preventDefault(); studio.editOps?.nudge(1, 0); setTimeout(populatePreview, 100); }
      if (e.key === 'Escape') { closeEditModal(); }
    }
  });
  
  document.getElementById('center-btn-{{ section.id }}').addEventListener('click', () => {
    studio.editOps?.center();
    setTimeout(populatePreview, 100);
  });
  
  document.getElementById('autofit-btn-{{ section.id }}').addEventListener('click', () => {
    studio.editOps?.autoFit();
    setTimeout(populatePreview, 100);
  });
  
  // ========================================
  // CROP TAB
  // ========================================
  const cropInitBtn = document.getElementById('crop-init-btn-{{ section.id }}');
  const cropApplyBtn = document.getElementById('crop-apply-btn-{{ section.id }}');
  const cropCancelBtn = document.getElementById('crop-cancel-btn-{{ section.id }}');
  
  cropInitBtn.addEventListener('click', () => {
    const success = studio.editOps?.initCrop();
    if (success) {
      cropApplyBtn.disabled = false;
      cropApplyBtn.style.opacity = '1';
      cropCancelBtn.disabled = false;
      cropCancelBtn.style.opacity = '1';
      cropInitBtn.disabled = true;
      cropInitBtn.style.opacity = '0.5';
    }
  });
  
  cropApplyBtn.addEventListener('click', () => {
    studio.editOps?.applyCrop();
    cropInitBtn.disabled = false;
    cropInitBtn.style.opacity = '1';
    cropApplyBtn.disabled = true;
    cropApplyBtn.style.opacity = '0.5';
    cropCancelBtn.disabled = true;
    cropCancelBtn.style.opacity = '0.5';
  });
  
  cropCancelBtn.addEventListener('click', () => {
    studio.editOps?.cancelCrop();
    cropInitBtn.disabled = false;
    cropInitBtn.style.opacity = '1';
    cropApplyBtn.disabled = true;
    cropApplyBtn.style.opacity = '0.5';
    cropCancelBtn.disabled = true;
    cropCancelBtn.style.opacity = '0.5';
  });
  
  // ========================================
  // BACKGROUND TAB
  // ========================================
  const bgToleranceSlider = document.getElementById('bg-tolerance-{{ section.id }}');
  const toleranceValue = document.getElementById('tolerance-value-{{ section.id }}');
  
  bgToleranceSlider.addEventListener('input', (e) => {
    toleranceValue.textContent = e.target.value;
  });
  
  document.getElementById('remove-bg-btn-{{ section.id }}').addEventListener('click', () => {
    const color = document.getElementById('bg-color-{{ section.id }}').value;
    const tolerance = parseInt(bgToleranceSlider.value);
    studio.editOps?.removeBackground(color, tolerance);
  });
  
  document.getElementById('revert-bg-btn-{{ section.id }}').addEventListener('click', () => {
    studio.editOps?.revertBackground();
  });
  
  // ========================================
  // ADJUST TAB
  // ========================================
  const opacitySlider = document.getElementById('opacity-slider-{{ section.id }}');
  const opacityValue = document.getElementById('opacity-value-{{ section.id }}');
  
  opacitySlider.addEventListener('input', (e) => {
    const val = e.target.value;
    opacityValue.textContent = val;
    studio.editOps?.setOpacity(val / 100);
  });
  
  const brightnessSlider = document.getElementById('brightness-slider-{{ section.id }}');
  const brightnessValue = document.getElementById('brightness-value-{{ section.id }}');
  
  brightnessSlider.addEventListener('input', (e) => {
    const val = e.target.value;
    brightnessValue.textContent = val;
    studio.editOps?.setBrightness(parseFloat(val));
  });
  
  const contrastSlider = document.getElementById('contrast-slider-{{ section.id }}');
  const contrastValue = document.getElementById('contrast-value-{{ section.id }}');
  
  contrastSlider.addEventListener('input', (e) => {
    const val = e.target.value;
    contrastValue.textContent = val;
    studio.editOps?.setContrast(parseFloat(val));
  });
  
  const grayscaleCheck = document.getElementById('grayscale-check-{{ section.id }}');
  grayscaleCheck.addEventListener('change', (e) => {
    studio.editOps?.setGrayscale(e.target.checked);
  });
  
  const outlineSlider = document.getElementById('outline-slider-{{ section.id }}');
  const outlineValue = document.getElementById('outline-value-{{ section.id }}');
  
  outlineSlider.addEventListener('input', (e) => {
    const val = e.target.value;
    outlineValue.textContent = val;
    studio.editOps?.addOutline(parseInt(val), '#000000');
  });
  
  // ========================================
  // REPLACE TAB
  // ========================================
  const replaceDropzone = document.getElementById('replace-dropzone-{{ section.id }}');
  const replaceInput = document.getElementById('replace-input-{{ section.id }}');
  
  replaceDropzone.addEventListener('click', () => {
    replaceInput.click();
  });
  
  replaceInput.addEventListener('change', (e) => {
    const file = e.target.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onload = (event) => {
        // This would replace the design while preserving transforms
        // Implementation depends on your existing upload system
        alert('üöß Replace functionality coming soon! Will preserve your position, scale, and rotation.');
      };
      reader.readAsDataURL(file);
    }
  });
  
  // ========================================
  // QUALITY TAB
  // ========================================
  function updateQualityMeter() {
    const info = studio.editOps?.qualityInfo();
    if (!info || !info.dpi) return;
    
    const dpiNumber = document.getElementById('dpi-number-{{ section.id }}');
    const qualityBadge = document.getElementById('quality-badge-{{ section.id }}');
    const qualityWarning = document.getElementById('quality-warning-{{ section.id }}');
    
    dpiNumber.textContent = info.dpi || '---';
    
    // Color coding
    if (info.level === 'excellent') {
      dpiNumber.style.color = '#27e1c1';
      qualityBadge.style.background = '#27e1c1';
      qualityBadge.style.color = '#0f172a';
      qualityBadge.textContent = '‚úì EXCELLENT QUALITY';
      qualityWarning.style.display = 'none';
    } else if (info.level === 'ok') {
      dpiNumber.style.color = '#f59e0b';
      qualityBadge.style.background = '#f59e0b';
      qualityBadge.style.color = 'white';
      qualityBadge.textContent = '‚ö† ACCEPTABLE QUALITY';
      qualityWarning.style.display = 'none';
    } else if (info.level === 'low') {
      dpiNumber.style.color = '#ef4444';
      qualityBadge.style.background = '#ef4444';
      qualityBadge.style.color = 'white';
      qualityBadge.textContent = '‚ö† LOW QUALITY';
      qualityWarning.style.display = 'block';
    } else {
      dpiNumber.style.color = '#dc2626';
      qualityBadge.style.background = '#dc2626';
      qualityBadge.style.color = 'white';
      qualityBadge.textContent = '‚ùå POOR QUALITY';
      qualityWarning.style.display = 'block';
    }
  }
  
  console.log('‚úÖ Edit Modal fully initialized with all 7 tabs');
}
</script>

<style>
/* ========================================
   MOBILE RESPONSIVE DESIGN WORKSPACE
   ======================================== */

/* Tablet & Medium Screens (768px and below) */
@media (max-width: 768px) {
  /* Main Studio Container */
  .custom-tshirt-studio {
    overflow-x: hidden !important;
    max-width: 100vw !important;
  }
  
  /* ===== CANVAS ZOOM SLIDER - MOBILE ===== */
  .zoom-bar {
    bottom: 12px !important;
    gap: 8px !important;
    padding: 6px 12px !important;
  }
  
  .zoom-icon {
    font-size: 18px !important;
  }
  
  .zoom-range {
    width: min(65vw, 220px) !important;
    height: 5px !important;
  }
  
  .zoom-range::-webkit-slider-thumb {
    width: 20px !important;
    height: 20px !important;
    border-width: 2px !important;
  }
  
  .zoom-range::-moz-range-thumb {
    width: 20px !important;
    height: 20px !important;
    border-width: 2px !important;
  }
  
  .zoom-label {
    min-width: 48px !important;
    font-size: 13px !important;
  }
  /* ===== END ZOOM SLIDER ===== */
  
  /* Studio Header */
  .studio-title {
    font-size: 2.25rem !important;
    word-wrap: break-word !important;
    overflow-wrap: break-word !important;
    line-height: 1.2 !important;
    padding: 0 15px !important;
  }
  
  .studio-subtitle {
    font-size: 1rem !important;
    padding: 0 15px !important;
  }
  
  .studio-description {
    font-size: 0.95rem !important;
    padding: 0 15px !important;
  }
  
  /* Design Workspace */
  .design-workspace {
    padding: 20px 12px !important;
    margin: 0 10px !important;
    border-radius: 16px !important;
    overflow-x: hidden !important;
    max-width: calc(100% - 20px) !important;
    box-sizing: border-box !important;
  }
  
  .workspace-header {
    flex-wrap: wrap !important;
    gap: 15px !important;
  }
  
  .workspace-title {
    font-size: 1.5rem !important;
    word-wrap: break-word !important;
    overflow-wrap: break-word !important;
    flex: 1 1 100% !important;
    text-align: center !important;
  }
  
  .close-studio-btn {
    flex: 0 0 auto !important;
    margin: 0 auto !important;
  }
  
  /* Mockup Section */
  #nt-mockup-{{ section.id }} {
    padding: 30px 0 15px 0 !important;
    overflow-x: hidden !important;
    max-width: 100vw !important;
  }
  
  .container {
    padding: 0 12px !important;
    max-width: 100% !important;
  }
  
  /* Mockup Header */
  .mockup-header {
    margin-bottom: 20px !important;
  }
  
  .mockup-header h1 {
    font-size: 2rem !important;
    word-wrap: break-word !important;
    overflow-wrap: break-word !important;
    padding: 0 15px !important;
    line-height: 1.2 !important;
    margin-bottom: 15px !important;
  }
  
  .mockup-header p {
    font-size: 1rem !important;
    padding: 0 15px !important;
    line-height: 1.6 !important;
  }
  
  /* Canvas Hint Text */
  .canvas-hint-text {
    font-size: 0.85rem !important;
    padding: 0 12px !important;
  }
  
  /* Controls Title */
  .canvas-controls-title {
    font-size: 1.5rem !important;
    padding: 0 12px !important;
  }
  
  .canvas-controls-subtitle {
    font-size: 0.85rem !important;
    padding: 0 12px !important;
  }
  
  /* Design Customization Controls Container */
  .nt-mockup__controls {
    flex-direction: column !important;
    padding: 16px 12px !important;
    gap: 16px !important;
    max-width: 100% !important;
    box-sizing: border-box !important;
  }
  
  /* Control Groups */
  .nt-mockup__group {
    width: 100% !important;
    display: flex !important;
    flex-direction: column !important;
    gap: 10px !important;
  }
  
  .nt-mockup__label {
    display: block !important;
    text-align: center !important;
    margin: 0 0 8px 0 !important;
    font-size: 0.9rem !important;
  }
  
  /* Button Containers - Grid Layout for Better Organization */
  .nt-mockup__buttons {
    display: grid !important;
    grid-template-columns: repeat(2, 1fr) !important;
    gap: 8px !important;
    width: 100% !important;
  }
  
  /* View Buttons - 2 columns on tablet */
  .nt-mockup__group:has(.nt-btn--view) .nt-mockup__buttons {
    grid-template-columns: repeat(2, 1fr) !important;
  }
  
  /* Color Buttons - 2 columns */
  .nt-mockup__group:has(.nt-btn--color) .nt-mockup__buttons {
    grid-template-columns: repeat(2, 1fr) !important;
  }
  
  /* 3D Controls - 2 columns */
  .nt-mockup__group:has(.nt-btn--3d) .nt-mockup__buttons {
    grid-template-columns: repeat(2, 1fr) !important;
  }
  
  /* Zoom Controls - Full width stack */
  .nt-mockup__group:has(.nt-btn--zoom-out) .nt-mockup__buttons {
    grid-template-columns: 1fr !important;
  }
  
  /* All Buttons - Mobile Optimized */
  .nt-btn {
    padding: 12px 16px !important;
    font-size: 0.85rem !important;
    border-radius: 12px !important;
    width: 100% !important;
    box-sizing: border-box !important;
    white-space: nowrap !important;
    text-align: center !important;
    justify-content: center !important;
  }
  
  /* Upload Section */
  .upload-section {
    width: 100% !important;
    margin-bottom: 16px !important;
  }
  
  .nt-btn--upload {
    width: 100% !important;
    padding: 16px 24px !important;
    font-size: 0.95rem !important;
    border-radius: 16px !important;
  }
  
  /* Action Buttons Grid */
  .action-buttons-grid {
    display: grid !important;
    grid-template-columns: 1fr !important;
    gap: 10px !important;
    width: 100% !important;
  }
  
  /* Primary Actions */
  .primary-actions {
    display: grid !important;
    grid-template-columns: 1fr !important;
    gap: 10px !important;
    width: 100% !important;
  }
  
  /* Submit Request Button */
  .submit-request-btn {
    width: 100% !important;
    padding: 16px 24px !important;
    font-size: 0.95rem !important;
    border-radius: 16px !important;
  }
  
  /* Canvas Container */
  .nt-mockup__canvas {
    max-width: 100% !important;
    width: min(95vw, 600px) !important;
    margin: 15px auto 25px auto !important;
    padding: 0 10px !important;
    box-sizing: border-box !important;
  }
  
  /* Canvas Stage */
  .nt-mockup__stage {
    margin-top: 20px !important;
    margin-bottom: 25px !important;
    display: flex !important;
    justify-content: center !important;
    align-items: center !important;
    padding: 0 !important;
  }
  
  /* 3-Step Workflow - Below Canvas */
  .workflow-steps {
    margin-top: 25px !important;
    max-width: 100% !important;
    padding: 0 16px !important;
    gap: 24px !important;
  }
  
  .workflow-step {
    width: 100% !important;
  }
  
  .step-label {
    font-size: 0.95rem !important;
    margin-bottom: 10px !important;
    gap: 6px !important;
  }
  
  .step-label span:first-child {
    width: 28px !important;
    height: 28px !important;
    font-size: 14px !important;
  }
  
  .step-description {
    font-size: 0.85rem !important;
    max-width: 95% !important;
    line-height: 1.5 !important;
  }
  
  .workflow-steps .nt-btn--upload {
    width: 100% !important;
    padding: 18px 32px !important;
    font-size: 1rem !important;
  }
  
  .workflow-steps .nt-btn--perfect-fit {
    width: 100% !important;
    padding: 16px 28px !important;
    font-size: 0.95rem !important;
  }
  
  .workflow-steps .nt-btn--submit-request {
    width: 100% !important;
    padding: 18px 32px !important;
    font-size: 1rem !important;
  }
  
  /* Size Chart */
  .size-chart-container {
    margin: 20px 10px !important;
    max-width: calc(100% - 20px) !important;
  }
  
  .size-chart-table {
    font-size: 0.7rem !important;
  }
  
  .size-chart-table th,
  .size-chart-table td {
    padding: 6px 4px !important;
  }
}

/* Mobile Phones (480px and below) */
@media (max-width: 480px) {
  /* ===== CANVAS ZOOM SLIDER - EXTRA SMALL MOBILE ===== */
  .zoom-bar {
    bottom: 10px !important;
    gap: 6px !important;
    padding: 5px 10px !important;
  }
  
  .zoom-icon {
    font-size: 16px !important;
  }
  
  .zoom-range {
    width: min(70vw, 180px) !important;
    height: 4px !important;
  }
  
  .zoom-range::-webkit-slider-thumb {
    width: 18px !important;
    height: 18px !important;
    border-width: 2px !important;
  }
  
  .zoom-range::-moz-range-thumb {
    width: 18px !important;
    height: 18px !important;
    border-width: 2px !important;
  }
  
  .zoom-label {
    min-width: 44px !important;
    font-size: 12px !important;
  }
  /* ===== END ZOOM SLIDER ===== */
  
  /* Studio Header */
  .studio-title {
    font-size: 1.85rem !important;
    padding: 0 12px !important;
  }
  
  .studio-subtitle {
    font-size: 0.95rem !important;
  }
  
  .studio-description {
    font-size: 0.9rem !important;
  }
  
  /* Design Workspace */
  .design-workspace {
    padding: 16px 10px !important;
    margin: 0 8px !important;
  }
  
  .workspace-title {
    font-size: 1.35rem !important;
  }
  
  /* Mockup Section */
  #nt-mockup-{{ section.id }} {
    padding: 20px 0 10px 0 !important;
  }
  
  .mockup-header {
    margin-bottom: 15px !important;
  }
  
  .mockup-header h1 {
    font-size: 1.75rem !important;
    padding: 0 12px !important;
    margin-bottom: 12px !important;
  }
  
  .mockup-header p {
    font-size: 0.9rem !important;
    padding: 0 12px !important;
  }
  
  /* Canvas */
  .nt-mockup__stage {
    margin-top: 15px !important;
    margin-bottom: 20px !important;
    display: flex !important;
    justify-content: center !important;
    align-items: center !important;
    padding: 0 !important;
  }
  
  .nt-mockup__canvas {
    width: min(95vw, 500px) !important;
    margin: 10px auto 20px auto !important;
    box-sizing: border-box !important;
  }
  
  /* Controls */
  .nt-mockup__controls {
    padding: 12px 10px !important;
    gap: 12px !important;
  }
  
  .canvas-controls-title {
    font-size: 1.35rem !important;
  }
  
  .canvas-controls-subtitle {
    font-size: 0.8rem !important;
  }
  
  /* Buttons */
  .nt-btn {
    padding: 11px 14px !important;
    font-size: 0.8rem !important;
    border-radius: 10px !important;
  }
  
  .nt-btn--upload {
    padding: 15px 20px !important;
    font-size: 0.9rem !important;
  }
  
  .submit-request-btn {
    padding: 15px 20px !important;
    font-size: 0.9rem !important;
  }
  
  /* 3-Step Workflow */
  .workflow-steps {
    margin-top: 20px !important;
    padding: 0 12px !important;
    gap: 20px !important;
  }
  
  .step-label {
    font-size: 0.9rem !important;
    margin-bottom: 8px !important;
    gap: 6px !important;
  }
  
  .step-label span:first-child {
    width: 26px !important;
    height: 26px !important;
    font-size: 13px !important;
  }
  
  .step-description {
    font-size: 0.8rem !important;
    max-width: 100% !important;
  }
  
  .workflow-steps .nt-btn--upload {
    padding: 16px 28px !important;
    font-size: 0.95rem !important;
  }
  
  .workflow-steps .nt-btn--perfect-fit {
    padding: 15px 24px !important;
    font-size: 0.9rem !important;
  }
  
  .workflow-steps .nt-btn--submit-request {
    padding: 16px 28px !important;
    font-size: 0.95rem !important;
  }
  
  /* View Buttons - Stack to single column on small phones */
  .nt-mockup__group:has(.nt-btn--view) .nt-mockup__buttons {
    grid-template-columns: 1fr !important;
  }
  
  /* Color Buttons - Keep 2 columns */
  .nt-mockup__group:has(.nt-btn--color) .nt-mockup__buttons {
    grid-template-columns: repeat(2, 1fr) !important;
  }
  
  /* 3D Controls - Keep 2 columns */
  .nt-mockup__group:has(.nt-btn--3d) .nt-mockup__buttons {
    grid-template-columns: repeat(2, 1fr) !important;
  }
  
  /* Size Chart */
  .size-chart-table {
    font-size: 0.65rem !important;
  }
  
  .size-chart-table th,
  .size-chart-table td {
    padding: 5px 3px !important;
  }
}

/* Very Small Phones (375px and below) */
@media (max-width: 375px) {
  /* Studio Header */
  .studio-title {
    font-size: 1.65rem !important;
    padding: 0 10px !important;
  }
  
  .studio-subtitle {
    font-size: 0.9rem !important;
  }
  
  .studio-description {
    font-size: 0.85rem !important;
  }
  
  /* Mockup Header */
  .mockup-header {
    margin-bottom: 12px !important;
  }
  
  .mockup-header h1 {
    font-size: 1.6rem !important;
    padding: 0 10px !important;
    margin-bottom: 10px !important;
  }
  
  .mockup-header p {
    font-size: 0.85rem !important;
    padding: 0 10px !important;
  }
  
  /* Canvas */
  .nt-mockup__stage {
    margin-top: 12px !important;
    margin-bottom: 15px !important;
    display: flex !important;
    justify-content: center !important;
    align-items: center !important;
    padding: 0 !important;
  }
  
  .nt-mockup__canvas {
    width: min(95vw, 400px) !important;
    margin: 8px auto 15px auto !important;
    box-sizing: border-box !important;
  }
  
  /* Controls */
  .canvas-controls-title {
    font-size: 1.25rem !important;
  }
  
  .canvas-controls-subtitle {
    font-size: 0.75rem !important;
  }
  
  /* Buttons */
  .nt-btn {
    padding: 10px 12px !important;
    font-size: 0.75rem !important;
  }
  
  .nt-btn--upload {
    padding: 14px 18px !important;
    font-size: 0.85rem !important;
  }
  
  .submit-request-btn {
    padding: 14px 18px !important;
    font-size: 0.85rem !important;
  }
  
  /* 3-Step Workflow */
  .workflow-steps {
    margin-top: 18px !important;
    padding: 0 10px !important;
    gap: 18px !important;
  }
  
  .step-label {
    font-size: 0.85rem !important;
    margin-bottom: 8px !important;
    gap: 5px !important;
    flex-wrap: wrap !important;
    justify-content: center !important;
  }
  
  .step-label span:first-child {
    width: 24px !important;
    height: 24px !important;
    font-size: 12px !important;
  }
  
  .step-description {
    font-size: 0.75rem !important;
    max-width: 100% !important;
    line-height: 1.5 !important;
  }
  
  .workflow-steps .nt-btn--upload {
    padding: 15px 24px !important;
    font-size: 0.9rem !important;
  }
  
  .workflow-steps .nt-btn--perfect-fit {
    padding: 14px 20px !important;
    font-size: 0.85rem !important;
  }
  
  .workflow-steps .nt-btn--submit-request {
    padding: 15px 24px !important;
    font-size: 0.9rem !important;
  }
  
  /* All buttons stack in single column on very small screens */
  .nt-mockup__buttons {
    grid-template-columns: 1fr !important;
  }
}

/* Extra optimizations for horizontal overflow prevention */
@media (max-width: 768px) {
  * {
    max-width: 100vw;
  }
  
  body,
  html {
    overflow-x: hidden !important;
  }
  
  .custom-designer-container {
    overflow-x: hidden !important;
    max-width: 100vw !important;
  }
  
  /* Ensure feature highlights wrap properly */
  div[style*="display: flex"][style*="gap: 25px"] {
    gap: 12px !important;
    padding: 15px 10px !important;
  }
  
  div[style*="display: flex"][style*="gap: 25px"] > div {
    font-size: 0.85rem !important;
  }
  
  div[style*="display: flex"][style*="gap: 25px"] span[style*="padding: 8px 12px"] {
    padding: 6px 10px !important;
    font-size: 0.75rem !important;
  }
}
</style>

{% schema %}
{
  "name": "Custom T-Shirt Studio",
  "tag": "section",
  "class": "section",
  "settings": [
    {
      "type": "text",
      "id": "title",
      "label": "Studio Title",
      "default": "Custom T-Shirt Studio"
    },
    {
      "type": "textarea",
      "id": "description",
      "label": "Studio Description",
      "default": "Create stunning custom t-shirts with our advanced design tools. Upload your artwork, customize colors, adjust positioning, and see your design come to life in real-time."
    },
    {
      "type": "header",
      "content": "Section Settings"
    },
    {
      "type": "range",
      "id": "padding_top",
      "min": 0,
      "max": 100,
      "step": 4,
      "unit": "px",
      "label": "Top padding",
      "default": 36
    },
    {
      "type": "range",
      "id": "padding_bottom",
      "min": 0,
      "max": 100,
      "step": 4,
      "unit": "px",
      "label": "Bottom padding",
      "default": 36
    }
  ],
  "presets": [
    {
      "name": "Custom T-Shirt Studio"
    }
  ]
}
{% endschema %}