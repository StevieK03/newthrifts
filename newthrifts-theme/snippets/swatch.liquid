{%- comment -%}
Robust swatch group (usually for Color). Emits buttons with:
data-option-index, data-value, data-variant-id, data-available,
data-media-id, data-img, data-price
{%- endcomment -%}

{%- assign opt_name = option_name | default: 'Color' -%}
{%- assign opt_index = 0 -%}
{%- assign oname_lc = opt_name | downcase -%}
{%- for opt in product.options -%}
  {%- assign opt_lc = opt | downcase -%}
  {%- if opt_lc == oname_lc -%}
    {%- assign opt_index = forloop.index0 -%}
    {%- break -%}
  {%- endif -%}
{%- endfor -%}

{%- assign current = product.selected_or_first_available_variant -%}

<div class="swatch-block" data-swatch-group data-option-index="{{ opt_index }}" aria-label="{{ opt_name }}">
  <div class="vp-legend">{{ opt_name }}</div>
  <div class="swatch-list">
    {%- assign seen = '' -%}
    {%- for v in product.options_with_values[opt_index].values -%}
      {%- assign key = v | downcase | strip -%}
      {%- if seen contains key -%}{% continue %}{%- endif -%}
      {%- assign seen = seen | append: key | append: ',' -%}

      {%- comment -%} Find best matching variant for this value {%- endcomment -%}
      {%- assign match = nil -%}
      {%- for variant in product.variants -%}
        {%- if variant.options[opt_index] == v -%}
          {%- assign ok = true -%}
          {%- for i in (0..product.options.size-1) -%}
            {%- if i != opt_index -%}
              {%- if current and current.options[i] and variant.options[i] != current.options[i] -%}
                {%- assign ok = false -%}
              {%- endif -%}
            {%- endif -%}
          {%- endfor -%}
          {%- if ok -%}{% assign match = variant %}{% break %}{%- endif -%}
        {%- endif -%}
      {%- endfor -%}
      {%- if match == nil -%}
        {%- for variant in product.variants -%}
          {%- if variant.options[opt_index] == v -%}{% assign match = variant %}{% break %}{%- endif -%}
        {%- endfor -%}
      {%- endif -%}

      {%- assign img = match.featured_media.preview_image | default: product.featured_image -%}
      {%- assign media_id = match.featured_media.id | default: '' -%}
      {%- assign price_str = match.price | money -%}

      <button
        type="button"
        class="swatch"
        data-swatch
        data-option-index="{{ opt_index }}"
        data-value="{{ v | escape }}"
        data-variant-id="{{ match.id }}"
        data-available="{{ match.available }}"
        {% if media_id != blank %}data-media-id="{{ media_id }}"{% endif %}
        data-img="{{ img | image_url: width: 800 }}"
        data-price="{{ price_str }}"
        aria-label="{{ opt_name }}: {{ v }}"
        title="{{ v }}"
      >
        <span class="swatch__chip" data-swatch-chip
              style="background-image:url('{{ img | image_url: width: 80 }}');"></span>
        <span class="swatch__label">{{ v }}</span>
      </button>
    {%- endfor -%}
  </div>
</div>
